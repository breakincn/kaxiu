import{e as l,s as A,u as H,x as O,f as b,g as a,j as Q,t as p,n as k,y as R,o as x}from"./vendor.Da2sdW28.js";import{_ as $,H as M}from"./PwaInstallGuide.DykFy_Bj.js";import{r as E,k as K,c as U}from"./index.DuRPLurf.js";import"./index.BYIGvkoh.js";const F={class:"min-h-screen bg-gray-50"},G={class:"bg-white px-4 py-3 flex items-center justify-between border-b sticky top-0 z-10"},J={class:"font-medium text-gray-800"},P={class:"px-4 py-4"},W={class:"bg-white rounded-xl p-4 shadow-sm"},X={class:"flex items-center justify-between mb-3"},Y={key:0,class:"mb-3 p-3 bg-gray-50 border border-gray-100 text-gray-700 rounded-lg text-sm"},Z={class:"mt-4 flex gap-2"},ee=["disabled"],te=["disabled"],oe={__name:"ScanVerify",setup(ae){const w=H(),L=l("扫码"),i=l(!1),v=l(!1),r=l(!1),y=l(""),c=l(""),h=l(!1),f=l(0),d=l([]);let u=null,S=0;const V=()=>{w.back()},T=async()=>{try{const t=await M.getCameras();if(d.value=t,t&&t.length>0){const e=t.find(s=>s.label.toLowerCase().includes("back")||s.label.toLowerCase().includes("environment")||s.label.toLowerCase().includes("后")||s.label.toLowerCase().includes("主"));if(e)f.value=t.indexOf(e);else{const s=t.find(n=>!n.label.toLowerCase().includes("front")&&!n.label.toLowerCase().includes("user")&&!n.label.toLowerCase().includes("前")&&!n.label.toLowerCase().includes("自"));s&&(f.value=t.indexOf(s))}}}catch{d.value=[]}},j=()=>{u||(u=new M("qr-reader"))},_=async()=>{var t;if(!(i.value||r.value)){y.value="",c.value="",i.value=!0;try{j(),await T();const e=(t=d.value[f.value])==null?void 0:t.id,s={fps:10,qrbox:{width:250,height:250},aspectRatio:1.777778},n=e?{deviceId:{exact:e}}:{facingMode:{exact:"environment"}};await u.start(n,s,async g=>{const m=Date.now();m-S<1200||(S=m,await D(g))},()=>{}),r.value=!0}catch(e){y.value=(e==null?void 0:e.message)||"启动摄像头失败",r.value=!1}finally{i.value=!1}}},C=async()=>{if(!(!u||!r.value))try{await u.stop(),await u.clear()}catch{}finally{r.value=!1}},q=async()=>{r.value&&(!d.value||d.value.length<=1||(f.value=(f.value+1)%d.value.length,await C(),await _()))},D=async t=>{var s,n,g,m,B,I;if(v.value)return;const e=(t||"").trim();if(e){v.value=!0;try{const o=await U.scanVerify(e),N=(n=(s=o==null?void 0:o.data)==null?void 0:s.data)==null?void 0:n.action;if(h.value=!0,N==="finish")c.value="结单成功！";else{const z=(m=(g=o==null?void 0:o.data)==null?void 0:g.data)==null?void 0:m.remain_times;c.value=`核销成功！剩余次数: ${z??"-"}`}setTimeout(()=>{w.replace({path:"/merchant",query:{tab:"verify"}})},700)}catch(o){h.value=!1,c.value=((I=(B=o.response)==null?void 0:B.data)==null?void 0:I.error)||"扫码失败"}finally{v.value=!1}}};return A(()=>{L.value="扫码";const t=E(),e=K();if(!t||!e){w.replace("/login");return}T(),_()}),O(()=>{C()}),(t,e)=>(x(),b("div",F,[a("header",G,[a("button",{onClick:V,class:"p-1 text-gray-600"},[...e[0]||(e[0]=[a("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),a("span",J,p(L.value),1),e[1]||(e[1]=a("div",{class:"w-8"},null,-1))]),Q($,{pageKey:"merchant_scan_verify"}),a("div",P,[a("div",W,[a("div",X,[e[2]||(e[2]=a("h3",{class:"font-medium text-gray-800"},"相机扫码",-1)),r.value?(x(),b("button",{key:0,onClick:C,class:"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm"}," 停止 ")):k("",!0)]),y.value?(x(),b("div",Y,p(y.value),1)):k("",!0),c.value?(x(),b("div",{key:1,class:R(["mb-3 p-3 rounded-lg text-sm",h.value?"bg-primary-light text-primary border border-gray-100":"bg-gray-50 text-gray-700 border border-gray-100"])},p(c.value),3)):k("",!0),e[3]||(e[3]=a("div",{class:"rounded-lg overflow-hidden border border-gray-200 bg-black"},[a("div",{id:"qr-reader",class:"w-full"})],-1)),a("div",Z,[a("button",{onClick:_,disabled:i.value||v.value,class:"flex-1 py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50"},p(r.value?"扫描中...":i.value?"启动中...":"开始扫码"),9,ee),a("button",{onClick:q,disabled:i.value||v.value||!r.value,class:"px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium disabled:opacity-50"}," 切换 ",8,te)]),e[4]||(e[4]=a("p",{class:"text-gray-400 text-xs mt-3"}," 提示：请允许浏览器使用摄像头权限，建议使用微信内置浏览器 / Safari / Chrome。 ",-1))])])]))}};export{oe as default};
