import{e as n,s as Q,u as z,x as F,f as p,g as t,j as H,n as h,t as C,w as V,o as g}from"./vendor.Da2sdW28.js";import{_ as O,H as B}from"./PwaInstallGuide.DykFy_Bj.js";import{r as R,k as T,c as U}from"./index.DuRPLurf.js";import"./index.BYIGvkoh.js";const W={class:"min-h-screen bg-gray-50"},$={class:"px-4 py-4"},E={class:"bg-white rounded-xl p-4 shadow-sm"},K={class:"flex items-center justify-between mb-3"},G={key:0,class:"mb-3 p-3 bg-gray-50 border border-gray-100 text-gray-700 rounded-lg text-sm"},J={key:1,class:"mb-3 flex items-center gap-2 p-3 bg-gray-50 border border-gray-100 text-gray-700 rounded-lg text-sm"},P={class:"mt-4 flex gap-2"},X=["disabled"],Y=["disabled"],Z={class:"bg-white rounded-2xl w-11/12 max-w-sm overflow-hidden"},ee={class:"px-5 py-5 text-gray-700 text-sm"},oe={__name:"ScanCard",setup(te){const b=z(),o=n(!1),i=n(!1),l=n(!1),y=n(""),c=n(!1),u=n(""),f=n(0),d=n([]);let v=null,_=0;const j=()=>{b.back()},I=async()=>{try{const a=await B.getCameras();if(d.value=a,a&&a.length>0){const e=a.find(s=>s.label.toLowerCase().includes("back")||s.label.toLowerCase().includes("environment")||s.label.toLowerCase().includes("后")||s.label.toLowerCase().includes("主"));if(e)f.value=a.indexOf(e);else{const s=a.find(r=>!r.label.toLowerCase().includes("front")&&!r.label.toLowerCase().includes("user")&&!r.label.toLowerCase().includes("前")&&!r.label.toLowerCase().includes("自"));s&&(f.value=a.indexOf(s))}}}catch{d.value=[]}},S=()=>{v||(v=new B("qr-reader"))},q=a=>{const e=(a||"").trim();if(!e)return null;if(e.startsWith("kabao-card:")){const s=e.slice(11).trim(),r=parseInt(s);return!Number.isFinite(r)||r<=0?null:r}return null},A=a=>{const e=(a||"").trim();return e&&e.startsWith("kabao-user:")?e:null},k=async()=>{var a;if(!(o.value||l.value)){y.value="",c.value=!1,u.value="",o.value=!0;try{S(),await I();const e=(a=d.value[f.value])==null?void 0:a.id,s={fps:10,qrbox:{width:250,height:250},aspectRatio:1.777778},r=e?{deviceId:{exact:e}}:{facingMode:{exact:"environment"}};await v.start(r,s,async w=>{const m=Date.now();m-_<1200||(_=m,await N(w))},()=>{}),l.value=!0}catch(e){y.value=(e==null?void 0:e.message)||"启动摄像头失败",l.value=!1}finally{o.value=!1}}},x=async()=>{if(!(!v||!l.value))try{await v.stop(),await v.clear()}catch{}finally{l.value=!1}},D=async()=>{l.value&&(!d.value||d.value.length<=1||(f.value=(f.value+1)%d.value.length,await x(),await k()))},N=async a=>{var r,w,m;if(i.value)return;const e=q(a),s=A(a);if(!e&&!s){c.value=!0,u.value="二维码格式不正确";return}i.value=!0;try{if(await x(),e){await U.getMerchantCard(e),b.replace(`/merchant/cards/${e}`);return}b.replace({path:"/merchant",query:{tab:"cards",user_code:s,from_scan:"1"}})}catch(M){((r=M.response)==null?void 0:r.status)===403?(c.value=!0,u.value="他家卡片，请出示我家卡片扫码"):(c.value=!0,u.value=((m=(w=M.response)==null?void 0:w.data)==null?void 0:m.error)||"查询失败")}finally{i.value=!1}},L=()=>{c.value=!1,u.value=""};return Q(()=>{const a=R(),e=T();if(!a||!e){b.replace("/login");return}I(),k()}),F(()=>{x()}),(a,e)=>(g(),p("div",W,[t("header",{class:"bg-white px-4 py-3 flex items-center justify-between border-b sticky top-0 z-10"},[t("button",{onClick:j,class:"p-1 text-gray-600"},[...e[0]||(e[0]=[t("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),e[1]||(e[1]=t("span",{class:"font-medium text-gray-800"},"扫码查询卡片",-1)),e[2]||(e[2]=t("div",{class:"w-8"},null,-1))]),H(O,{pageKey:"merchant_scan_card"}),t("div",$,[t("div",E,[t("div",K,[e[3]||(e[3]=t("h3",{class:"font-medium text-gray-800"},"相机扫码",-1)),l.value?(g(),p("button",{key:0,onClick:x,class:"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm"}," 停止 ")):h("",!0)]),y.value?(g(),p("div",G,C(y.value),1)):h("",!0),i.value?(g(),p("div",J,[...e[4]||(e[4]=[t("svg",{class:"w-4 h-4 animate-spin",viewBox:"0 0 24 24",fill:"none"},[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})],-1),t("span",null,"查询中...",-1)])])):h("",!0),e[5]||(e[5]=t("div",{class:"rounded-lg overflow-hidden border border-gray-200 bg-black"},[t("div",{id:"qr-reader",class:"w-full"})],-1)),t("div",P,[t("button",{onClick:k,disabled:o.value||i.value,class:"flex-1 py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50"},C(l.value?"扫描中...":o.value?"启动中...":"开始扫码"),9,X),t("button",{onClick:D,disabled:o.value||i.value||!l.value,class:"px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium disabled:opacity-50"}," 切换 ",8,Y)]),e[6]||(e[6]=t("p",{class:"text-gray-400 text-xs mt-3"}," 提示：用户端卡片二维码格式为 kabao-card:<卡片ID> ",-1))])]),c.value?(g(),p("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:V(L,["self"])},[t("div",Z,[e[7]||(e[7]=t("div",{class:"px-5 py-4 border-b"},[t("div",{class:"font-medium text-gray-800"},"提示")],-1)),t("div",ee,C(u.value),1),t("div",{class:"px-5 pb-5"},[t("button",{onClick:L,class:"w-full py-3 bg-primary text-white rounded-lg font-medium"}," 我知道了 ")])])])):h("",!0)]))}};export{oe as default};
