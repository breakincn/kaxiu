import{e as o,p as w,q as k,s as _,x as C,f as u,g as t,y as B,t as M,u as q,B as D,o as v}from"./vendor.Da2sdW28.js";import{Q as E}from"./browser.DZr5NsCX.js";import{f as L}from"./index.DuRPLurf.js";import"./index.BYIGvkoh.js";const Q={class:"min-h-screen bg-gray-50"},S={class:"px-4 py-6"},T={class:"bg-white rounded-xl shadow-sm p-6"},U={class:"text-center"},V={class:"mt-5 flex items-center justify-center"},j={class:"rounded-2xl bg-white p-4 border border-gray-100",style:{"-webkit-touch-callout":"none","-webkit-user-select":"none","user-select":"none"}},z={class:"mt-4"},A={key:0,class:"text-gray-400"},I=["disabled"],H={__name:"UserCode",setup(N){const g=q(),i=o(null),a=o(!1),l=o(""),m=o(0),p=o(Date.now()),c=o(!0);let d=null;const n=w(()=>{const s=(m.value||0)*1e3;if(!s)return 0;const e=Math.floor((s-p.value)/1e3);return e>0?e:0});k(n,async s=>{s===0&&c.value&&!a.value&&await r()});const b=()=>{g.back()},h=async()=>{try{if(await D(),!i.value||!l.value)return;await E.toCanvas(i.value,l.value,{margin:1,scale:8,errorCorrectionLevel:"M"})}catch{}},r=async()=>{var s,e;if(!a.value){a.value=!0;try{const x=(await L.getUserCode()).data.data||{};l.value=String(x.code||""),m.value=Number(x.expires_at||0),await h()}catch(f){alert(((e=(s=f.response)==null?void 0:s.data)==null?void 0:e.error)||"获取用户码失败")}finally{a.value=!1}}},y=()=>{c.value=!document.hidden,c.value&&n.value===0&&!a.value&&r()};return _(async()=>{d=setInterval(()=>{p.value=Date.now()},500),document.addEventListener("visibilitychange",y),await r()}),C(()=>{d&&clearInterval(d),document.removeEventListener("visibilitychange",y)}),(s,e)=>(v(),u("div",Q,[t("header",{class:"bg-white px-4 py-3 flex items-center gap-3 border-b sticky top-0 z-10"},[t("button",{onClick:b,class:"p-1"},[...e[0]||(e[0]=[t("svg",{class:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),e[1]||(e[1]=t("span",{class:"font-medium text-gray-800"},"我的用户码",-1))]),t("div",S,[t("div",T,[t("div",U,[e[2]||(e[2]=t("div",{class:"text-gray-800 font-medium"},"请商户扫码查询我的卡片",-1)),e[3]||(e[3]=t("div",{class:"text-gray-500 text-sm mt-1"},"用户码有效期 5 分钟",-1)),t("div",V,[t("div",j,[t("canvas",{ref_key:"qrCanvas",ref:i,class:"block",style:{width:"220px",height:"220px"}},null,512)])]),t("div",z,[a.value?(v(),u("div",A,"加载中...")):(v(),u("div",{key:1,class:B(["text-sm",n.value>0?"text-gray-600":"text-red-600"])},M(n.value>0?`剩余 ${n.value} 秒`:"已过期，请刷新"),3))]),t("button",{type:"button",class:"mt-5 w-full bg-primary text-white py-3 rounded-lg font-medium disabled:opacity-50",onClick:r,disabled:a.value}," 刷新用户码 ",8,I),e[4]||(e[4]=t("p",{class:"text-gray-400 text-xs mt-3"}," 提示：请在商户面前打开此页面，避免截图传播。 ",-1))])])])]))}};export{H as default};
