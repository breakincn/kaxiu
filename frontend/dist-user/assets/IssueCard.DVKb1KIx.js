import{e as d,p as B,q as P,s as Y,f as o,g as a,n as m,i as M,v as I,t as r,F,z as V,I as $,u as q,o as n}from"./vendor.Da2sdW28.js";import{j as Q,k as R,r as G,b as H,m as J,c as K}from"./index.DuRPLurf.js";import"./index.BYIGvkoh.js";const W={class:"min-h-screen bg-gray-50"},X={class:"px-4 py-4 space-y-4"},Z={class:"bg-white rounded-xl p-4 shadow-sm"},ee={class:"flex gap-2"},te=["disabled"],ae={key:0,class:"mt-3 text-sm text-gray-700"},se={key:1,class:"mt-4 space-y-2"},re=["onClick"],le={class:"flex items-center justify-between"},oe={class:"text-gray-800 font-medium"},ne={class:"text-gray-500 text-sm"},de={key:2,class:"mt-4 text-center text-gray-400"},ue={key:0,class:"bg-white rounded-xl p-4 shadow-sm"},ie={class:"flex items-start justify-between"},ce={class:"text-gray-700 mt-2"},ve={class:"text-gray-500 text-sm"},me={class:"text-gray-500 text-sm"},pe={class:"bg-white rounded-xl p-4 shadow-sm"},ye={class:"space-y-3"},be=["value"],ge={key:0,class:"px-4 py-3 border border-gray-100 rounded-lg bg-gray-50"},_e={class:"text-sm text-gray-700"},fe={key:0,class:"text-sm text-gray-700"},xe={class:"text-sm text-gray-700"},he={class:"grid grid-cols-2 gap-3"},ke=["disabled"],we={key:1,class:"text-sm text-gray-700"},Ce={key:2,class:"text-sm text-primary"},Te={__name:"IssueCard",setup(Me){const f=q(),p=d(""),y=d(!1),x=d(!1),h=d(""),k=d([]),u=d(null),b=d(!1),i=d(""),g=d(""),l=d({template_id:0,start_date:"",end_date:""}),w=d([]),v=B(()=>{const s=Number(l.value.template_id||0);return s&&(w.value||[]).find(e=>Number(e.id)===s)||null}),j=async()=>{try{const e=(await H.getCardTemplates()).data.data||[];w.value=e.filter(t=>t&&(t.card_type==="times"||t.card_type==="lesson"||t.card_type==="balance"))}catch{w.value=[]}},S=(s,e)=>{const t=s?new Date(s):new Date,c=new Date(t),C=Number(e||0);return C>0?c.setDate(c.getDate()+C):c.setFullYear(c.getFullYear()+20),c.toISOString().split("T")[0]},E=s=>({times:"次数卡",lesson:"课时卡",balance:"充值卡"})[s]||s;P([()=>l.value.start_date,()=>v.value],([s,e])=>{if(!e){l.value.end_date="";return}l.value.end_date=S(s,e.valid_days)});const T=B(()=>!!(u.value&&u.value.id&&v.value&&l.value.end_date)),U=()=>{f.back()},D=()=>{const s=R(),e=G();if(!s||!e)return f.replace("/login"),!1;const t=Number.parseInt(s,10);return Number.isNaN(t)||t<=0?(f.replace("/login"),!1):!0},L=async()=>{var s,e;if(D()&&!(!p.value||y.value)){y.value=!0,x.value=!1,h.value="",k.value=[];try{const t=await J.searchUsersByPhone(p.value);k.value=t.data.data||[],x.value=!0}catch(t){h.value=((e=(s=t.response)==null?void 0:s.data)==null?void 0:e.error)||"搜索失败",x.value=!0}finally{y.value=!1}}},A=s=>{u.value=s,g.value="",i.value=""},O=()=>{u.value=null,g.value="",i.value=""},z=async()=>{var s,e;if(D()&&!(!T.value||b.value)){b.value=!0,i.value="",g.value="";try{const t=v.value;if(!t){i.value="请选择卡片模板";return}const c=l.value.start_date||new Date().toISOString().split("T")[0],C=S(c,t.valid_days),_={user_id:u.value.id,card_type:t.name,total_times:t.card_type==="balance"?0:Number(t.total_times)||0,recharge_amount:t.card_type==="balance"?Math.round((Number(t.recharge_amount)||0)/100):0,start_date:c,end_date:C};if(t.card_type==="balance"&&(!_.recharge_amount||_.recharge_amount<=0)){i.value="充值卡充值金额必须大于0";return}if(t.card_type!=="balance"&&(!_.total_times||_.total_times<=0)){i.value="总次数必须大于0";return}const N=(await K.createCard(_)).data.data;alert(`发卡成功：卡号 ${(N==null?void 0:N.card_no)||""}`),f.push("/merchant?tab=cards")}catch(t){i.value=((e=(s=t.response)==null?void 0:s.data)==null?void 0:e.error)||"发卡失败"}finally{b.value=!1}}};return Y(()=>{if(D(),!Q("merchant.card.issue")){alert("您没有发卡权限，请联系管理员开通"),U();return}j();const s=new Date().toISOString().split("T")[0];l.value.start_date=s}),(s,e)=>(n(),o("div",W,[a("header",{class:"bg-white px-4 py-3 flex items-center gap-3 border-b sticky top-0 z-10"},[a("button",{onClick:U,class:"p-1"},[...e[4]||(e[4]=[a("svg",{class:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),e[5]||(e[5]=a("span",{class:"font-medium text-gray-800"},"发卡 / 开卡",-1))]),a("div",X,[a("div",Z,[e[7]||(e[7]=a("div",{class:"font-medium text-gray-800 mb-3"},"通过手机号搜索用户",-1)),a("div",ee,[M(a("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>p.value=t),type:"tel",placeholder:"输入手机号（支持模糊搜索）",class:"flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary"},null,512),[[I,p.value]]),a("button",{onClick:L,disabled:!p.value||y.value,class:"px-4 py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50"},r(y.value?"搜索中...":"搜索"),9,te)]),h.value?(n(),o("div",ae,r(h.value),1)):m("",!0),k.value.length>0?(n(),o("div",se,[(n(!0),o(F,null,V(k.value,t=>(n(),o("button",{key:t.id,onClick:c=>A(t),class:"w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:border-primary"},[a("div",le,[a("div",null,[a("div",oe,r(t.nickname||"未命名用户"),1),a("div",ne,"手机号："+r(t.phone),1)]),e[6]||(e[6]=a("div",{class:"text-primary text-sm font-medium"},"选择",-1))])],8,re))),128))])):x.value?(n(),o("div",de," 未找到用户 ")):m("",!0)]),u.value?(n(),o("div",ue,[a("div",ie,[a("div",null,[e[8]||(e[8]=a("div",{class:"font-medium text-gray-800"},"已选择用户",-1)),a("div",ce,r(u.value.nickname||"未命名用户"),1),a("div",ve,"手机号："+r(u.value.phone),1),a("div",me,"用户ID："+r(u.value.id),1)]),a("button",{onClick:O,class:"text-gray-400 hover:text-gray-600"},[...e[9]||(e[9]=[a("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):m("",!0),a("div",pe,[e[14]||(e[14]=a("div",{class:"font-medium text-gray-800 mb-4"},"卡信息",-1)),a("div",ye,[a("div",null,[e[11]||(e[11]=a("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"选择卡片",-1)),M(a("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.template_id=t),class:"w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary"},[e[10]||(e[10]=a("option",{value:0},"请选择售卡模板",-1)),(n(!0),o(F,null,V(w.value,t=>(n(),o("option",{key:t.id,value:t.id},r(t.name)+"（¥"+r((t.price/100).toFixed(2))+"） ",9,be))),128))],512),[[$,l.value.template_id,void 0,{number:!0}]])]),v.value?(n(),o("div",ge,[a("div",_e,"类型："+r(E(v.value.card_type)),1),v.value.card_type!=="balance"?(n(),o("div",fe,"次数："+r(v.value.total_times),1)):m("",!0),a("div",xe,"售价：¥"+r((v.value.price/100).toFixed(2)),1)])):m("",!0),a("div",he,[a("div",null,[e[12]||(e[12]=a("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"开始日期（可选）",-1)),M(a("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>l.value.start_date=t),type:"date",class:"w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary"},null,512),[[I,l.value.start_date]])]),a("div",null,[e[13]||(e[13]=a("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"结束日期",-1)),M(a("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>l.value.end_date=t),type:"date",disabled:"",class:"w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary bg-gray-50 text-gray-500"},null,512),[[I,l.value.end_date]])])]),a("button",{onClick:z,disabled:b.value||!T.value,class:"w-full mt-2 py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50"},r(b.value?"提交中...":"确认发卡"),9,ke),i.value?(n(),o("div",we,r(i.value),1)):m("",!0),g.value?(n(),o("div",Ce,r(g.value),1)):m("",!0)])])])]))}};export{Te as default};
