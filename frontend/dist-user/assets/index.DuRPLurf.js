const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.BYIGvkoh.js","assets/vendor.Da2sdW28.js","assets/index.CawrLTIk.css"])))=>i.map(i=>d[i]);
import{a as u}from"./index.BYIGvkoh.js";import{E as P}from"./vendor.Da2sdW28.js";const i=()=>sessionStorage.getItem("merchantActiveAuth")==="staff"?"staff":"merchant",z=e=>{sessionStorage.setItem("merchantActiveAuth",e==="staff"?"staff":"merchant")},$=()=>i()==="staff"?localStorage.getItem("technicianToken"):localStorage.getItem("merchantToken"),J=()=>i()==="staff"?localStorage.getItem("technicianMerchantId"):localStorage.getItem("merchantId"),y=()=>sessionStorage.getItem("technicianShopSlug")||"",Q=e=>{e?sessionStorage.setItem("technicianShopSlug",String(e)):sessionStorage.removeItem("technicianShopSlug")},M=()=>{if(i()==="staff"){localStorage.removeItem("technicianToken"),localStorage.removeItem("technicianMerchantId"),localStorage.removeItem("technicianMerchantName"),localStorage.removeItem("technicianMerchantPhone"),sessionStorage.removeItem("technicianId"),sessionStorage.removeItem("technicianName"),sessionStorage.removeItem("technicianCode"),sessionStorage.removeItem("technicianAccount"),sessionStorage.removeItem("technicianShopSlug"),sessionStorage.removeItem("merchantActiveAuth");return}localStorage.removeItem("merchantToken"),localStorage.removeItem("merchantId"),localStorage.removeItem("merchantName"),localStorage.removeItem("merchantPhone"),sessionStorage.removeItem("merchantActiveAuth")},C=()=>{try{const e=sessionStorage.getItem("merchantPermissionKeys");if(!e)return[];const s=JSON.parse(e);return Array.isArray(s)?s:[]}catch{return[]}},T=e=>{const s=Array.isArray(e)?e:[];sessionStorage.setItem("merchantPermissionKeys",JSON.stringify(s))},b=()=>{sessionStorage.removeItem("merchantPermissionKeys")},X=e=>{const s=String(e||"").trim();if(!s)return!1;const n=C();return n.includes("*")?!0:n.includes(s)},k="https://api.kabao.app",t=P.create({baseURL:k,timeout:1e4}),l=typeof window<"u"?window.location.host:"",_=l==="kabao.shop"||l.endsWith(".kabao.shop"),d=e=>/^\/s\/[^/]+\/login$/.test(e),f=e=>_?!0:e.startsWith("/merchant")||d(e),w=e=>e.startsWith("/platform-admin");t.interceptors.request.use(e=>{const s=f(window.location.pathname);if(w(window.location.pathname)){const r=localStorage.getItem("platformAdminToken");return r&&(e.headers["X-Platform-Admin-Token"]=r),e}const n=s?$():localStorage.getItem("userToken");return n&&(e.headers.Authorization=`Bearer ${n}`),e},e=>Promise.reject(e));t.interceptors.response.use(e=>e,e=>{var s,n,r,h,p,g;if(console.log("API响应错误:",(s=e.response)==null?void 0:s.status,(n=e.config)==null?void 0:n.url),e.response&&e.response.status===401){console.log("收到401错误，检查错误类型和请求上下文");const v=(h=(r=e.config)==null?void 0:r.url)==null?void 0:h.includes("/login"),A=((g=(p=e.config)==null?void 0:p.method)==null?void 0:g.toLowerCase())==="post";if(v&&A)return console.log("主动登录请求失败，不清空现有登录态"),sessionStorage.removeItem("merchantActiveAuth"),sessionStorage.removeItem("technicianShopSlug"),Promise.reject(e);console.log("会话过期或无效token，清除登录态并跳转登录页");const m=window.location.pathname;if(f(m)){const c=i(),o=y();b(),M(),u(async()=>{const{default:a}=await import("./index.BYIGvkoh.js").then(I=>I.i);return{default:a}},__vite__mapDeps([0,1,2])).then(({default:a})=>{d(m)?a.replace(m):c==="staff"&&o?a.replace(`/s/${o}/login`):a.replace("/login")})}else localStorage.removeItem("userToken"),localStorage.removeItem("userId"),localStorage.removeItem("userName"),u(async()=>{const{default:c}=await import("./index.BYIGvkoh.js").then(o=>o.i);return{default:c}},__vite__mapDeps([0,1,2])).then(({default:c})=>{c.replace("/login")})}return Promise.reject(e)});const R={login:(e,s)=>t.post("/user/login",{username:e,password:s}),register:e=>t.post("/user/register",e),getCurrentUser:()=>t.get("/user/me")},U={sendCode:(e,s)=>t.post("/user/sms/send",{phone:e,type:s})},N={getServiceRoles:()=>t.get("/platform/service-roles")},L={listServiceRoles:()=>t.get("/admin/service-roles"),createServiceRole:e=>t.post("/admin/service-roles",e),updateServiceRole:(e,s)=>t.put(`/admin/service-roles/${e}`,s),deleteServiceRole:e=>t.delete(`/admin/service-roles/${e}`),listPermissions:()=>t.get("/admin/permissions"),createPermission:e=>t.post("/admin/permissions",e),updatePermission:(e,s)=>t.put(`/admin/permissions/${e}`,s),deletePermission:e=>t.delete(`/admin/permissions/${e}`),getRolePermissions:e=>t.get(`/admin/service-roles/${e}/permissions`),setRolePermissions:(e,s)=>t.post(`/admin/service-roles/${e}/permissions`,s)},D={getUsers:()=>t.get("/user/users"),getUser:e=>t.get(`/user/users/${e}`),createUser:e=>t.post("/user/users",e),bindPhone:(e,s)=>t.post("/user/bind-phone",{phone:e,code:s}),getUserCode:()=>t.get("/user/code"),getCurrentUser:()=>t.get("/user/me")},S={register:e=>t.post("/merchant/register",e),login:(e,s)=>t.post("/merchant/login",{phone:e,password:s}),getMerchants:()=>t.get("/merchant/merchants"),getMerchant:e=>t.get(`/merchant/merchants/${e}`),createMerchant:e=>t.post("/merchant/merchants",e),updateMerchant:(e,s)=>t.put(`/merchant/merchants/${e}`,s),updateTechnicianAlias:e=>t.put("/merchant/technician-alias",e),getQueueStatus:e=>t.get(`/merchant/merchants/${e}/queue`),searchUsersByPhone:e=>t.get("/merchant/users/search",{params:{phone:e}}),bindPhone:(e,s,n)=>t.post("/merchant/bind-phone",{phone:e,code:s,password:n}),getCurrentMerchant:()=>t.get("/merchant/me"),updateCurrentMerchantServices:e=>t.put("/merchant/services",e),updateMerchantInfo:e=>t.put("/merchant/info",e),getNextCardNo:()=>t.get("/merchant/next-card-no"),toggleBusinessStatus:e=>t.put("/merchant/business-status",e),getMyPermissions:()=>t.get("/merchant/permissions"),getCurrentTechnician:()=>t.get("/merchant/technician/me"),bindTechnicianPhone:(e,s)=>t.post("/merchant/technician/bind-phone",{phone:e,code:s}),getTechnicians:e=>t.get("/merchant/technicians",{params:{role:e}}),createTechnician:e=>t.post("/merchant/technicians",e),updateTechnician:(e,s)=>t.put(`/merchant/technicians/${e}`,s),deleteTechnician:e=>t.delete(`/merchant/technicians/${e}`),getRolePermissions:e=>t.get(`/merchant/role-permissions/${e}`),setRolePermissions:(e,s)=>t.post(`/merchant/role-permissions/${e}`,s)},j=async()=>{var e,s;try{const r=((s=(e=(await S.getMyPermissions()).data)==null?void 0:e.data)==null?void 0:s.permission_keys)||[];return T(r),r}catch{return[]}},x={getCards:()=>t.get("/user/cards"),getCard:e=>t.get(`/user/cards/${e}`),getUserCards:(e,s)=>t.get(`/user/users/${e}/cards`,{params:{status:s}}),getMerchantCards:(e,s)=>t.get(`/merchant/merchants/${e}/cards`,{params:s}),getMerchantCard:e=>t.get(`/merchant/cards/${e}`),createCard:e=>t.post("/merchant/cards",e),updateCard:(e,s)=>t.put(`/merchant/cards/${e}`,s),generateVerifyCode:e=>t.post(`/user/cards/${e}/verify-code`),verifyCard:e=>t.post("/merchant/verify",{code:e}),scanVerify:e=>t.post("/merchant/verify/scan",{code:e}),finishVerify:e=>t.post("/merchant/verify/finish",{code:e}),getTodayVerify:e=>t.get(`/merchant/merchants/${e}/today-verify`)},B={getCardUsages:e=>t.get(`/user/cards/${e}/usages`),getMerchantUsages:e=>t.get(`/merchant/merchants/${e}/usages`)},K={getMerchantNotices:(e,s)=>t.get(`/merchant/merchants/${e}/notices`,{params:{limit:s}}),createNotice:e=>t.post("/merchant/notices",e),deleteNotice:e=>t.delete(`/merchant/notices/${e}`),togglePinNotice:e=>t.put(`/merchant/notices/${e}/pin`)},O={getMerchantAppointments:(e,s)=>t.get(`/merchant/merchants/${e}/appointments`,{params:{status:s}}),getMerchantTechnicians:e=>t.get(`/merchant/merchants/${e}/technicians`),getUserAppointments:e=>t.get(`/user/users/${e}/appointments`),getCardAppointment:e=>t.get(`/user/cards/${e}/appointment`),getAvailableTimeSlots:(e,s)=>t.get(`/merchant/merchants/${e}/available-slots`,{params:{date:s}}),createAppointment:e=>t.post("/user/appointments",e),confirmAppointment:e=>t.put(`/merchant/appointments/${e}/confirm`),finishAppointment:e=>t.put(`/merchant/appointments/${e}/finish`),cancelAppointment:e=>t.put(`/user/appointments/${e}/cancel`)},V={getPaymentConfig:()=>t.get("/merchant/payment-config"),savePaymentConfig:e=>t.post("/merchant/payment-config",e),uploadPaymentQRCode:e=>t.post("/merchant/payment-qrcode/upload",e),getCardTemplates:()=>t.get("/merchant/card-templates"),createCardTemplate:e=>t.post("/merchant/card-templates",e),updateCardTemplate:(e,s)=>t.put(`/merchant/card-templates/${e}`,s),deleteCardTemplate:e=>t.delete(`/merchant/card-templates/${e}`),getShopSlug:()=>t.get("/merchant/shop-slug"),saveShopSlug:e=>t.post("/merchant/shop-slug",{slug:e}),getMerchantDirectPurchases:()=>t.get("/merchant/direct-purchases"),confirmMerchantDirectPurchase:e=>t.post(`/merchant/direct-purchases/${e}/confirm`),getShopInfo:e=>t.get(`/user/s/${e}`),getShopInfoByID:e=>t.get(`/user/s/id/${e}`),technicianLogin:(e,s,n)=>t.post(`/merchant/s/${e}/login`,{account:s,password:n}),createDirectPurchase:e=>t.post("/user/direct-purchase",e),confirmDirectPurchase:(e,s)=>t.post(`/user/direct-purchase/${e}/confirm`,s),getDirectPurchases:()=>t.get("/user/direct-purchases"),toggleBusinessStatus:e=>t.put("/merchant/business-status",e)},F=Object.freeze(Object.defineProperty({__proto__:null,appointmentApi:O,authApi:R,cardApi:x,default:t,ensureMerchantPermissionsLoaded:j,merchantApi:S,noticeApi:K,platformAdminApi:L,platformApi:N,shopApi:V,smsApi:U,usageApi:B,userApi:D},Symbol.toStringTag,{value:"Module"}));export{R as a,V as b,x as c,O as d,t as e,D as f,z as g,Q as h,j as i,X as j,J as k,i as l,S as m,K as n,y as o,b as p,M as q,$ as r,U as s,N as t,B as u,L as v,F as w};
