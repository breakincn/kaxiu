import{e as c,p as g,q as Ke,s as Bt,D as Ft,u as Qt,G as Lt,x as Et,H as Ht,f as r,g as s,n as u,j as zt,k as De,r as Rt,t as i,c as Ze,y,F,z as Q,i as re,v as fe,I as Ot,C as Wt,w as z,B as et,o,l as tt,A as $}from"./vendor.Da2sdW28.js";import{j as A,i as Xt,k as Yt,m as Ie,b as je,d as pe,c as st,n as xe,u as Gt}from"./index.DuRPLurf.js";import{a as R,f as qe}from"./dateFormat.BMJ2_UIx.js";import{Q as Jt}from"./browser.DZr5NsCX.js";import{_ as Kt}from"./index.BYIGvkoh.js";const Zt={class:"min-h-screen bg-gray-50"},es={class:"bg-white px-4 py-3 flex items-center justify-between border-b"},ts={class:"flex items-center gap-3"},ss={class:"px-4 py-5 bg-white border-b"},ns={class:"flex items-start justify-between gap-3"},as={class:"text-xl font-bold text-gray-800"},os={class:"text-gray-500 text-sm mt-1"},rs={class:"flex gap-2"},ls={class:"px-4 pt-4"},is={class:"px-4 flex gap-2 border-b bg-white"},us={key:0,class:"px-4 py-4 space-y-4"},cs={class:"flex justify-between items-start mb-2"},ds={class:"font-medium text-gray-800"},vs={class:"text-gray-500 text-sm"},ms={class:"flex gap-2 mt-3"},ys=["onClick"],gs={key:1,disabled:"",class:"flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg text-sm font-medium cursor-not-allowed"},fs=["onClick"],ps={key:3,disabled:"",class:"flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg text-sm font-medium cursor-not-allowed"},xs=["onClick"],hs={key:0,class:"text-center py-12 text-gray-400"},bs={key:1,class:"px-4 py-4"},_s={key:0,class:"bg-white rounded-xl p-4 shadow-sm"},ws={key:1,class:"bg-white rounded-xl p-4 shadow-sm"},ks={class:"flex items-center justify-between mb-4"},Cs=["disabled"],Ts={class:"bg-white rounded-xl p-4 shadow-sm mt-4"},Ss={class:"flex items-center justify-between mb-4"},Ms={key:0,class:"space-y-3"},$s={class:"text-gray-800"},As={class:"text-gray-400 text-sm"},Ds={class:"text-gray-700 text-sm"},Is={key:1,class:"text-center text-gray-400 py-4"},js={key:2,class:"px-4 py-4"},qs={class:"bg-white rounded-xl p-4 shadow-sm mt-4"},Us={key:0,class:"space-y-3"},Ns={class:"text-gray-800"},Ps={class:"text-gray-400 text-sm"},Vs={class:"text-gray-700 text-sm"},Bs={key:1,class:"text-center text-gray-400 py-4"},Fs={key:3,class:"px-4 py-4"},Qs={class:"bg-white rounded-xl p-4 shadow-sm"},Ls={key:0,class:"mb-3 p-3 bg-primary-light border border-gray-100 rounded-lg text-gray-700 text-sm"},Es=["disabled"],Hs=["disabled"],zs=["disabled"],Rs={class:"bg-white rounded-xl p-4 shadow-sm mt-4"},Os={class:"font-medium text-gray-800 mb-4"},Ws={key:0,class:"space-y-4"},Xs={class:"flex items-start justify-between gap-2"},Ys={class:"flex-1"},Gs={class:"flex items-center gap-2"},Js={class:"font-medium text-gray-800"},Ks={key:0,class:"px-2 py-0.5 bg-primary-light text-primary text-xs rounded"},Zs={class:"text-gray-500 text-sm mt-1"},en={class:"text-gray-400 text-xs mt-1"},tn={class:"flex flex-col gap-2"},sn=["onClick"],nn=["onClick"],an={key:1,class:"text-center text-gray-400 py-4"},on={key:4,class:"px-4 py-4"},rn={key:0,class:"bg-gray-50 border border-gray-100 text-gray-700 rounded-lg p-3 text-sm mb-4"},ln={class:"bg-white rounded-xl p-4 shadow-sm mb-4"},un=["value"],cn={key:2,class:"flex-1"},dn={key:2,class:"text-center py-12 text-gray-400"},vn={key:3},mn=["onClick"],yn={class:"flex justify-between items-start mb-1"},gn={class:"text-lg font-bold"},fn={class:"text-gray-500 text-xs mt-0.5"},pn={class:"bg-gray-100 px-2.5 py-0.5 rounded-full"},xn={class:"text-xs font-medium"},hn={class:"flex justify-between items-end mt-6"},bn={class:"text-5xl font-bold leading-none"},_n={class:"text-right"},wn={class:"text-sm font-medium"},kn={key:0,class:"mt-3 bg-gray-50 rounded-2xl p-5 shadow-md border border-gray-200"},Cn={class:"space-y-3.5"},Tn={class:"flex justify-between"},Sn={class:"text-gray-800"},Mn={class:"flex justify-between"},$n={class:"text-gray-800"},An={class:"flex justify-between"},Dn={class:"text-gray-800"},In={class:"flex justify-between"},jn={class:"text-gray-800"},qn={class:"flex justify-between"},Un={class:"text-gray-800"},Nn={class:"flex justify-between"},Pn={class:"text-gray-800"},Vn={class:"flex justify-between"},Bn={class:"text-gray-800"},Fn={key:1,class:"text-center py-12 text-gray-400"},Qn={key:4},Ln={key:0,class:"text-center py-12 text-gray-400"},En={key:1,class:"template-list"},Hn=["onClick"],zn={class:"template-info"},Rn={class:"template-name"},On={class:"template-meta"},Wn={class:"type-tag"},Xn={class:"price"},Yn={class:"template-detail"},Gn={key:0},Jn={key:1},Kn={key:2},Zn={key:3},ea={class:"bg-white rounded-2xl w-11/12 max-w-sm overflow-hidden"},ta={class:"px-5 py-6"},sa={class:"text-gray-600 mb-6"},na={class:"flex gap-3"},aa={class:"bg-white rounded-2xl w-11/12 max-w-lg overflow-hidden"},oa={class:"bg-primary text-white px-5 py-4 flex items-center justify-between"},ra={class:"font-medium text-lg"},la={class:"px-5 py-5"},ia={class:"text-center"},ua={class:"text-gray-800 font-medium"},ca={class:"mt-4 flex justify-center"},da={__name:"Dashboard",setup(va){const D=Qt(),O=Ft();let b=null,W=null;const Ue=c(0),L={userSelect:"",webkitUserSelect:"",webkitTouchCallout:""},_=c(null),m=c({}),nt=g(()=>A("merchant.business_status.update")),he=g(()=>A("merchant.direct_sale.manage")),at=g(()=>A("merchant.card.issue")),be=g(()=>A("merchant.card.finish")),f=g(()=>A("merchant.card.verify")),ot=g(()=>A("merchant.notice.manage")),Ne=g(()=>A("merchant.appointment.view")),Pe=g(()=>A("merchant.appointment.manage")),_e=g(()=>{let t=0;return he.value&&m.value.support_direct_sale&&t++,w.value&&t++,f.value&&t++,t}),w=g(()=>{const t=Ne.value||Pe.value,e=m.value&&m.value.support_appointment===!0;return console.log("showQueueTab:",{hasPermission:t,merchantSupportsAppointment:e,merchant:m.value}),e&&t}),I=g(()=>(console.log("showVerifyTab:",f.value),f.value)),j=g(()=>(console.log("showFinishTab:",be.value),be.value)),q=g(()=>ot.value),Ve=g(()=>A("merchant.card.sell")),U=g(()=>f.value||Ve.value),l=c("queue"),p=c(""),Be=c(null);c(!1),c(!1);const we=c(!1),X=c(null),rt=c(""),Fe=c(null);g(()=>(Te.value||[]).filter(t=>t&&t.is_active));const lt=g(()=>X.value&&X.value.name?X.value.name:""),it=g(()=>{if(Y()){const e=sessionStorage.getItem("technicianAccount");if(e)return`技师: ${e}`;const a=sessionStorage.getItem("technicianCode");return a?`技师: ${a}`:"技师"}return localStorage.getItem("merchantPhone")||"商户"}),Y=()=>sessionStorage.getItem("merchantActiveAuth")==="staff",Qe=()=>{const t=sessionStorage.getItem("technicianId");if(!t)return null;const e=parseInt(String(t),10);return Number.isFinite(e)&&e>0?e:null},ut=()=>{const t=sessionStorage.getItem("technicianName"),e=sessionStorage.getItem("technicianCode");return t||(e?`技师${e}`:"技师")},Le=g(()=>Ve.value&&!!m.value.support_direct_sale&&Y()&&!!Qe()),k=c(!1),ke=c(0),Ce=c(0),le=c(0),ie=c([]),G=c([]),T=c([]),P=c(Date.now());let ue=null;const S=c(""),J=c(!1),x=c(null),V=c(!1),h=c({title:"",content:""});c("cards");const K=c([]),Z=c([]),N=c("auto"),ee=g(()=>N.value!=="auto"?N.value:!f.value&&Le.value?"sellTemplates":"cards"),ce=c(!1),de=c(""),ve=c(null),M=c({card_no:"",card_type:""}),Te=c([]),te=c(!1),Ee=t=>({times:"次数卡",lesson:"课时卡",balance:"充值卡"})[t]||t,He=()=>{D.push("/merchant/scan-verify")},ct=()=>{D.push("/merchant/scan-verify")},dt=()=>{Date.now()<Ue.value||He()},vt=t=>{b&&(clearTimeout(b),b=null),W=null;try{L.userSelect=document.body.style.userSelect,L.webkitUserSelect=document.body.style.webkitUserSelect,L.webkitTouchCallout=document.body.style.webkitTouchCallout,document.documentElement.classList.add("kb-no-select"),document.body.classList.add("kb-no-select"),document.body.style.userSelect="none",document.body.style.webkitUserSelect="none",document.body.style.webkitTouchCallout="none"}catch{}b=setTimeout(()=>{Ue.value=Date.now()+900,D.push("/merchant/scan-card")},820)},mt=t=>{var d;if(!b)return;const e=(d=t==null?void 0:t.touches)==null?void 0:d[0];if(!e)return;if(!W){W={x:e.clientX,y:e.clientY};return}const a=e.clientX-W.x,n=e.clientY-W.y;a*a+n*n>144&&(clearTimeout(b),b=null)},ze=()=>{b&&(clearTimeout(b),b=null);try{document.documentElement.classList.remove("kb-no-select"),document.body.classList.remove("kb-no-select"),document.body.style.userSelect=L.userSelect,document.body.style.webkitUserSelect=L.webkitUserSelect,document.body.style.webkitTouchCallout=L.webkitTouchCallout}catch{}},yt=()=>{m.value.support_direct_sale&&D.push({path:"/merchant/shop-manage",query:{tab:"orders"}})},Re=async()=>{try{const t=await Ie.getMerchant(_.value);m.value=t.data.data}catch(t){console.error("获取商户信息失败:",t)}},gt=async()=>{try{const e=(await je.getCardTemplates()).data.data||[];Te.value=e.filter(a=>a&&(a.card_type==="times"||a.card_type==="lesson"||a.card_type==="balance")),rt.value=""}catch(t){console.error("加载卡片模板失败",t)}},ft=async()=>{N.value="cards",await B()},Oe=async()=>{var t;console.log("loadSellTemplates 被调用, isTechnicianAuth():",Y()),N.value="sellTemplates",console.log("displayMode 设置为:",N.value),console.log("currentDisplay 现在是:",ee.value);try{const e=await je.getCardTemplates();console.log("API 响应:",e),Z.value=(e.data.data||[]).filter(a=>a&&a.is_active),console.log("售卡模板数据:",Z.value)}catch(e){console.error("加载售卡模板失败",e),((t=e.response)==null?void 0:t.status)===403?alert("您没有售卡权限，请联系管理员开通"):alert("加载售卡模板失败，请稍后重试"),Z.value=[],N.value="auto"}},pt=async t=>{if(!t||!t.id)return;const e=Qe();if(!e){alert("技师信息丢失");return}X.value=t,we.value=!0,await et();try{const a=`${window.location.origin}/shop?card_template_id=${t.id}&tech_id=${e}`,n=Fe.value;n&&await Jt.toCanvas(n,a,{width:224,margin:1,color:{dark:"#000000",light:"#FFFFFF"}})}catch(a){console.error("生成售卡二维码失败",a),alert("生成二维码失败")}},We=()=>{we.value=!1,X.value=null},xt=async()=>{M.value={card_no:"",card_type:""},ve.value=null,N.value="auto",await B()},ht=async()=>{p.value="",k.value=!1,await D.replace({path:"/merchant",query:{tab:"cards"}}),await B()},Xe=async()=>{await et(),await new Promise(e=>setTimeout(e,100));const t=Be.value;if(t)try{t.scrollIntoView({behavior:"smooth",block:"start"})}catch{}},bt=()=>{const t=window.innerHeight||800;return`${Math.max(t-600,200)}px`},Ye=async()=>{try{await D.replace({path:"/merchant",query:{tab:"cards"}})}catch{}},se=async()=>{try{const t=await Ie.getQueueStatus(_.value);ke.value=t.data.data.today_verify_count||0,Ce.value=t.data.data.pending_appointments||0}catch(t){console.error("获取队列状态失败:",t)}},_t=async()=>{if(!m.value.support_direct_sale){le.value=0;return}try{const e=(await je.getMerchantDirectPurchases()).data.data||[];le.value=e.filter(a=>a&&a.status==="paid").length}catch(t){console.error("获取待确认订单失败:",t)}},ne=async()=>{if(!m.value.support_appointment){ie.value=[];return}try{const t=await pe.getMerchantAppointments(_.value);ie.value=(t.data.data||[]).filter(e=>e.status!=="finished"&&e.status!=="canceled")}catch(t){console.error("获取预约列表失败:",t)}},Se=async()=>{try{const t=await Gt.getMerchantUsages(_.value),e=new Date().toISOString().split("T")[0];G.value=(t.data.data||[]).filter(a=>a.used_at&&a.used_at.startsWith(e))}catch(t){console.error("获取核销记录失败:",t)}},me=async()=>{try{const t=await xe.getMerchantNotices(_.value);T.value=t.data.data||[]}catch(t){console.error("获取通知列表失败:",t)}},B=async()=>{var t,e;if(_.value&&!ce.value){ce.value=!0,de.value="";try{const a={};M.value.card_no&&(a.card_no=M.value.card_no),M.value.card_type&&(a.card_type=M.value.card_type),p.value&&(a.user_code=p.value);let d=(await st.getMerchantCards(_.value,a)).data.data||[];d.sort((v,C)=>{const E=new Date(v.created_at).getTime(),H=new Date(C.created_at).getTime();if(E!==H)return H-E;const ae=v.last_used_at?new Date(v.last_used_at).getTime():0;return(C.last_used_at?new Date(C.last_used_at).getTime():0)-ae}),K.value=d}catch(a){de.value=((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.error)||"获取卡片列表失败"}finally{ce.value=!1}}},wt=t=>{ve.value=ve.value===t?null:t},kt=async t=>{var e,a;try{await pe.confirmAppointment(t),ne(),se()}catch(n){alert(((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.error)||"确认失败")}},Ct=async t=>{var e,a;try{await pe.finishAppointment(t),ne(),se()}catch(n){alert(((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.error)||"完成失败")}},Tt=async t=>{var e,a;if(confirm("确定要取消这个预约吗？此操作不可撤销。"))try{await pe.cancelAppointment(t),ne(),se(),alert("预约已取消")}catch(n){alert(((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.error)||"取消失败")}},St=async()=>{var t,e;if(!(!S.value||J.value)){J.value=!0,x.value=null;try{const a=await st.verifyCard(S.value);x.value={success:!0,message:`核销成功！剩余次数: ${a.data.data.remain_times}`},S.value="",se(),Se(),setTimeout(()=>{V.value=!1,x.value=null},2e3)}catch(a){x.value={success:!1,message:((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.error)||"核销失败"}}finally{J.value=!1}}},Mt=async()=>{var t,e;if(!(!h.value.title||!h.value.content||T.value.length>=3))try{await xe.createNotice({merchant_id:_.value,title:h.value.title,content:h.value.content}),h.value={title:"",content:""},me(),alert("发布成功")}catch(a){alert(((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.error)||"发布失败")}},$t=async t=>{var e,a;if(confirm("确定要删除这条通知吗？"))try{await xe.deleteNotice(t),me(),alert("删除成功")}catch(n){alert(((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.error)||"删除失败")}},At=async t=>{var e,a;try{await xe.togglePinNotice(t),me()}catch(n){alert(((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.error)||"操作失败")}},Dt=async()=>{var t,e;try{const a=!m.value.is_open;await Ie.toggleBusinessStatus({is_open:a}),m.value.is_open=a,te.value=!1,alert(a?"已切换为营业中":"已切换为打烊")}catch(a){alert(((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.error)||"操作失败")}},It=t=>t?t.status==="pending"&&ye(t)||t.status==="confirmed"&&ge(t)?"px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-500":{pending:"px-2 py-1 rounded text-xs font-medium bg-primary-light text-primary",confirmed:"px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700",finished:"px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700",canceled:"px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-500"}[t.status]||"":"",jt=t=>t?t.status==="pending"&&ye(t)?"过期未确认":t.status==="confirmed"&&ge(t)?"已过服务时间":{pending:"待确认",confirmed:"排队中",finished:"已完成",canceled:"已取消"}[t.status]||t.status:"",ye=t=>{if(!t||t.status!=="pending"||!t.appointment_time)return!1;const e=new Date(t.appointment_time).getTime();return P.value>e},ge=t=>{if(!t||t.status!=="confirmed"||!t.appointment_time)return!1;const e=new Date(t.appointment_time).getTime();let a=m.value.avg_service_minutes;(!a||a<=0)&&(a=30);const n=e+(a+30)*60*1e3;return P.value>n},Ge=t=>{if(!t||t.status!=="confirmed"||!t.appointment_time)return!1;const e=new Date(t.appointment_time).getTime();let a=m.value.avg_service_minutes;(!a||a<=0)&&(a=30);const n=e+a*60*1e3;return P.value>n},Me=t=>{if(!t||t.status!=="pending"||!t.appointment_time)return null;const e=new Date(t.appointment_time).getTime(),a=P.value;return Math.floor((e-a)/1e3)},qt=t=>{const e=Me(t);if(e===null)return"";if(e<=0)return"预约时间已过";const a=Math.abs(e),n=Math.floor(a/3600),d=Math.floor(a%3600/60),v=a%60;return n>0?`${n}小时${d}分${v}秒`:d>0?`${d}分${v}秒`:`${v}秒`},Ut=t=>{const e=Me(t);return e===null||e<=0?"text-gray-400 text-sm font-medium mt-1":e<=600?"text-primary text-sm font-medium mt-1":"text-gray-500 text-sm font-medium mt-1"},$e=t=>{if(!t||!t.appointment_time)return null;const e=new Date(t.appointment_time).getTime(),a=P.value;return Math.floor((e-a)/1e3)},Nt=t=>{const e=$e(t);if(e===null)return"";if(e<=0){const C=Math.abs(e),E=Math.floor(C/3600),H=Math.floor(C%3600/60),ae=C%60;let oe="";return E>0?oe=`${E}小时${H}分${ae}秒`:H>0?oe=`${H}分${ae}秒`:oe=`${ae}秒`,`已服务时间 ${oe}`}const a=Math.abs(e),n=Math.floor(a/3600),d=Math.floor(a%3600/60),v=a%60;return n>0?`${n}小时${d}分${v}秒`:d>0?`${d}分${v}秒`:`${v}秒`},Pt=t=>{if(Ge(t))return"text-gray-400 text-sm font-medium mt-1";const e=$e(t);return e===null||e<=600?"text-primary text-sm font-medium mt-1":"text-gray-500 text-sm font-medium mt-1"},Vt=t=>{if(t.status!=="confirmed"||!t.appointment_time)return!1;const e=new Date(t.appointment_time).getTime(),n=P.value-e;let d=m.value.avg_service_minutes;(!d||d<=0)&&(d=30);const v=(d-1)*60*1e3;return n>=v},Je=()=>{Ae(),ue=setInterval(()=>{P.value=Date.now()},1e3)},Ae=()=>{ue&&(clearInterval(ue),ue=null)};return Ke(l,t=>{t!=="cards"&&k.value&&(k.value=!1,p.value=""),t==="queue"?(ne(),Je()):(Ae(),t==="verify"?(V.value=!1,S.value="",x.value=null,Se()):t==="finish"?Se():t==="cards"?(N.value="auto",ee.value==="sellTemplates"?Oe():B()):t==="notice"&&me())}),Ke(()=>O.query.user_code,async t=>{if(t){p.value=String(t),k.value=String(O.query.from_scan||"")==="1",l.value==="cards"&&(await B(),k.value&&(await Xe(),await Ye()));return}k.value||(p.value="",l.value==="cards"&&await B())}),Bt(async()=>{console.log("Merchant Dashboard mounted"),console.log("localStorage merchantId:",localStorage.getItem("merchantId")),await Xt(),console.log("Permissions loaded, checking permissions:",{canAppointmentView:Ne.value,canAppointmentManage:Pe.value,canVerify:f.value,canFinishVerify:be.value});const t=O.query.tab;t&&["queue","verify","finish","notice","cards"].includes(t)&&(l.value=t);const e=O.query.user_code;p.value=e?String(e):"",k.value=!!e&&String(O.query.from_scan||"")==="1";const a=Yt();if(!a){console.log("No merchantId found, redirecting to login"),D.replace("/login");return}const n=Number.parseInt(a,10);if(Number.isNaN(n)||n<=0){console.log("Invalid merchantId:",a,"redirecting to login"),D.replace("/login");return}console.log("Valid merchantId:",n,"loading data..."),_.value=n,await Re(),console.log("Merchant loaded:",m.value),t?l.value==="queue"&&!w.value?I.value?l.value="verify":j.value?l.value="finish":q.value?l.value="notice":l.value=U.value?"cards":"queue":l.value==="verify"&&!I.value?w.value?l.value="queue":j.value?l.value="finish":q.value?l.value="notice":l.value=U.value?"cards":"queue":l.value==="finish"&&!j.value?w.value?l.value="queue":I.value?l.value="verify":q.value?l.value="notice":l.value=U.value?"cards":"queue":l.value==="notice"&&!q.value?w.value?l.value="queue":I.value?l.value="verify":j.value?l.value="finish":l.value=U.value?"cards":"queue":l.value==="cards"&&!U.value&&(w.value?l.value="queue":I.value?l.value="verify":j.value?l.value="finish":q.value?l.value="notice":l.value="queue"):w.value?l.value="queue":I.value?l.value="verify":j.value?l.value="finish":q.value?l.value="notice":l.value=U.value?"cards":"queue",se(),_t(),ne(),gt(),m.value.support_appointment&&Je(),l.value==="cards"&&k.value&&p.value&&(await B(),await Xe(),await Ye())}),Lt(()=>{k.value=!1,p.value=""}),Et(()=>{Ae(),k.value=!1,p.value=""}),Ht(()=>{_.value&&Re()}),(t,e)=>{const a=Rt("router-link");return o(),r("div",Zt,[s("header",es,[e[24]||(e[24]=s("div",{class:"flex items-center gap-2"},[s("span",{class:"text-primary font-bold text-xl"},"卡包"),s("span",{class:"text-gray-400 text-xs"},"kabao.shop")],-1)),s("div",ts,[s("button",{type:"button",class:"p-1 text-gray-500 hover:text-primary",onClick:dt,onTouchstart:vt,onTouchmove:mt,onTouchend:ze,onTouchcancel:ze,style:{"-webkit-touch-callout":"none","-webkit-user-select":"none","user-select":"none"}},[...e[22]||(e[22]=[s("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 4h-1a2 2 0 00-2 2v1m0 10v1a2 2 0 002 2h1m10-16h1a2 2 0 012 2v1m0 10v1a2 2 0 01-2 2h-1"}),s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 11h8m-8 4h8"})],-1)])],32),zt(a,{to:"/merchant/settings",class:"p-1 text-gray-500 hover:text-primary"},{default:De(()=>[...e[23]||(e[23]=[s("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1)])]),_:1})])]),s("div",ss,[s("div",ns,[s("div",null,[s("h1",as,i(m.value.name),1),s("p",os,i(it.value),1)]),s("div",rs,[he.value?(o(),Ze(a,{key:0,to:"/merchant/shop-manage",class:"px-3 py-2 bg-slate-600 text-white rounded-lg text-sm font-medium hover:bg-slate-700 transition-colors"},{default:De(()=>[...e[25]||(e[25]=[tt(" 售卡管理 ",-1)])]),_:1})):u("",!0),at.value?(o(),Ze(a,{key:1,to:"/merchant/issue-card",class:"px-3 py-2 bg-slate-600 text-white rounded-lg text-sm font-medium hover:bg-slate-700 transition-colors"},{default:De(()=>[...e[26]||(e[26]=[tt(" 发卡/开卡 ",-1)])]),_:1})):u("",!0)])])]),s("div",ls,[nt.value?(o(),r("button",{key:0,onClick:e[0]||(e[0]=n=>te.value=!0),class:y(["w-full py-3.5 rounded-lg font-medium text-base transition-colors",m.value.is_open?"bg-green-500 text-white hover:bg-green-600":"bg-red-500 text-white hover:bg-red-600"])},i(m.value.is_open?"营业中":"打烊"),3)):u("",!0)]),s("div",{class:y(["px-4 py-4 grid gap-3",{"grid-cols-1":_e.value===1,"grid-cols-2":_e.value===2,"grid-cols-3":_e.value===3}])},[he.value&&m.value.support_direct_sale?(o(),r("button",{key:0,type:"button",class:"bg-white rounded-xl p-4 text-left border border-gray-100",onClick:yt},[e[27]||(e[27]=s("div",{class:"text-gray-600 text-sm mb-1"},"待确认订单",-1)),s("div",{class:y(["text-3xl font-bold",le.value>0?"text-red-500":"text-gray-400"])},i(le.value),3),e[28]||(e[28]=s("div",{class:"text-gray-500 text-sm"},"单",-1))])):u("",!0),w.value?(o(),r("button",{key:1,type:"button",class:"bg-white rounded-xl p-4 text-left border border-gray-100",onClick:e[1]||(e[1]=n=>l.value="queue")},[e[29]||(e[29]=s("div",{class:"text-gray-600 text-sm mb-1"},"待处理预约",-1)),s("div",{class:y(["text-3xl font-bold",Ce.value>0?"text-orange-500":"text-gray-400"])},i(Ce.value),3),e[30]||(e[30]=s("div",{class:"text-gray-500 text-sm"},"人",-1))])):u("",!0),f.value?(o(),r("button",{key:2,type:"button",class:"bg-white rounded-xl p-4 text-left border border-gray-100",onClick:e[2]||(e[2]=n=>l.value="verify")},[e[31]||(e[31]=s("div",{class:"text-gray-600 text-sm mb-1"},"今日核销",-1)),s("div",{class:y(["text-3xl font-bold",ke.value>0?"text-secondary":"text-gray-400"])},i(ke.value),3),e[32]||(e[32]=s("div",{class:"text-gray-500 text-sm"},"次",-1))])):u("",!0)],2),s("div",is,[w.value?(o(),r("button",{key:0,onClick:e[3]||(e[3]=n=>l.value="queue"),class:y(["px-4 py-3 text-sm font-medium border-b-2 transition-colors",l.value==="queue"?"border-primary text-primary":"border-transparent text-gray-500"])}," 排队 ",2)):u("",!0),I.value?(o(),r("button",{key:1,onClick:e[4]||(e[4]=n=>l.value="verify"),class:y(["px-4 py-3 text-sm font-medium border-b-2 transition-colors",l.value==="verify"?"border-primary text-primary":"border-transparent text-gray-500"])}," 扫码核销 ",2)):u("",!0),j.value?(o(),r("button",{key:2,onClick:e[5]||(e[5]=n=>l.value="finish"),class:y(["px-4 py-3 text-sm font-medium border-b-2 transition-colors",l.value==="finish"?"border-primary text-primary":"border-transparent text-gray-500"])}," 扫码结单 ",2)):u("",!0),q.value?(o(),r("button",{key:3,onClick:e[6]||(e[6]=n=>l.value="notice"),class:y(["px-4 py-3 text-sm font-medium border-b-2 transition-colors",l.value==="notice"?"border-primary text-primary":"border-transparent text-gray-500"])}," 通知 ",2)):u("",!0),U.value?(o(),r("button",{key:4,onClick:e[7]||(e[7]=n=>l.value="cards"),class:y(["px-4 py-3 text-sm font-medium border-b-2 transition-colors",l.value==="cards"?"border-primary text-primary":"border-transparent text-gray-500"])}," 卡片 ",2)):u("",!0)]),l.value==="queue"&&w.value?(o(),r("div",us,[(o(!0),r(F,null,Q(ie.value,n=>{var d;return o(),r("div",{key:n.id,class:"bg-white rounded-xl p-4 shadow-sm"},[s("div",cs,[s("div",null,[s("div",ds,"用户 ID: "+i(((d=n.user)==null?void 0:d.nickname)||n.user_id),1),s("div",vs,"预约时间: "+i($(R)(n.appointment_time)),1),n.status==="pending"&&Me(n)!==null?(o(),r("div",{key:0,class:y(Ut(n))},i(qt(n)),3)):u("",!0),n.status==="confirmed"&&$e(n)!==null&&!Ge(n)?(o(),r("div",{key:1,class:y(Pt(n))},i(Nt(n)),3)):u("",!0)]),s("span",{class:y(It(n))},i(jt(n)),3)]),s("div",ms,[n.status==="pending"&&!ye(n)?(o(),r("button",{key:0,onClick:v=>kt(n.id),class:"flex-1 py-2 bg-primary text-white rounded-lg text-sm font-medium"}," 确认预约 ",8,ys)):u("",!0),n.status==="pending"&&ye(n)?(o(),r("button",gs," 未确认预约 ")):u("",!0),Vt(n)&&!ge(n)?(o(),r("button",{key:2,onClick:v=>Ct(n.id),class:"flex-1 py-2 bg-gray-900 text-white rounded-lg text-sm font-medium"}," 完成服务 (扣次) ",8,fs)):u("",!0),n.status==="confirmed"&&ge(n)?(o(),r("button",ps," 未核销 ")):u("",!0),n.status!=="finished"&&n.status!=="canceled"?(o(),r("button",{key:4,onClick:v=>Tt(n.id),class:"px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm"}," 取消 ",8,xs)):u("",!0)])])}),128)),ie.value.length===0?(o(),r("div",hs," 暂无预约 ")):u("",!0)])):u("",!0),l.value==="verify"&&I.value?(o(),r("div",bs,[V.value?(o(),r("div",ws,[s("div",ks,[e[33]||(e[33]=s("h3",{class:"font-medium text-gray-800"},"输入核销码",-1)),s("button",{onClick:e[8]||(e[8]=n=>{V.value=!1,S.value="",x.value=null}),class:"text-gray-500 hover:text-gray-700 text-sm"}," 取消 ")]),re(s("input",{"onUpdate:modelValue":e[9]||(e[9]=n=>S.value=n),type:"text",placeholder:"请输入用户的核销码",class:"w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary"},null,512),[[fe,S.value]]),s("button",{onClick:St,disabled:!S.value||J.value,class:"w-full mt-4 py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50"},i(J.value?"核销中...":"确认核销"),9,Cs),x.value?(o(),r("div",{key:0,class:y(["mt-4 p-4 rounded-lg",x.value.success?"bg-primary-light":"bg-gray-50"])},[s("p",{class:y(x.value.success?"text-primary":"text-gray-700")},i(x.value.message),3)],2)):u("",!0)])):(o(),r("div",_s,[s("button",{onClick:He,class:"w-full py-3 bg-primary text-white rounded-lg font-medium"}," 扫码核销 ")])),s("div",Ts,[s("div",Ss,[e[34]||(e[34]=s("h3",{class:"font-medium text-gray-800"},"今日核销记录",-1)),V.value?(o(),r("button",{key:1,onClick:e[11]||(e[11]=n=>{V.value=!1,S.value="",x.value=null}),class:"px-3 py-2 bg-primary text-white rounded-lg text-sm font-medium"}," 扫码核销 ")):(o(),r("button",{key:0,onClick:e[10]||(e[10]=n=>V.value=!0),class:"px-3 py-2 bg-primary text-white rounded-lg text-sm font-medium"}," 输入核销码 "))]),G.value.length>0?(o(),r("div",Ms,[(o(!0),r(F,null,Q(G.value,n=>{var d,v;return o(),r("div",{key:n.id,class:"flex justify-between items-center py-2 border-b last:border-0"},[s("div",null,[s("div",$s,i(((v=(d=n.card)==null?void 0:d.user)==null?void 0:v.nickname)||"用户"),1),s("div",As,i($(R)(n.used_at)),1)]),s("span",Ds,"核销 "+i(n.used_times)+" 次",1)])}),128))])):(o(),r("div",Is," 今日暂无核销 "))])])):u("",!0),l.value==="finish"&&j.value?(o(),r("div",js,[s("div",{class:"bg-white rounded-xl p-4 shadow-sm"},[s("button",{onClick:ct,class:"w-full py-3 bg-primary text-white rounded-lg font-medium"}," 扫码结单 ")]),s("div",qs,[e[35]||(e[35]=s("h3",{class:"font-medium text-gray-800 mb-4"},"今日结单记录",-1)),G.value.length>0?(o(),r("div",Us,[(o(!0),r(F,null,Q(G.value,n=>{var d,v;return o(),r("div",{key:n.id,class:"flex justify-between items-center py-2 border-b last:border-0"},[s("div",null,[s("div",Ns,i(((v=(d=n.card)==null?void 0:d.user)==null?void 0:v.nickname)||"用户"),1),s("div",Ps,i($(R)(n.used_at)),1)]),s("span",Vs,"结单 "+i(n.used_times)+" 次",1)])}),128))])):(o(),r("div",Bs," 今日暂无结单 "))])])):u("",!0),l.value==="notice"&&q.value?(o(),r("div",Fs,[s("div",Qs,[e[37]||(e[37]=s("h3",{class:"font-medium text-gray-800 mb-4"},"发布通知",-1)),T.value.length>=3?(o(),r("div",Ls,[...e[36]||(e[36]=[s("p",null,"已达到最大限制（3条），请先删除一条通知后再发布",-1)])])):u("",!0),re(s("input",{"onUpdate:modelValue":e[12]||(e[12]=n=>h.value.title=n),type:"text",placeholder:"通知标题",disabled:T.value.length>=3,class:"w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary mb-3 disabled:bg-gray-100"},null,8,Es),[[fe,h.value.title]]),re(s("textarea",{"onUpdate:modelValue":e[13]||(e[13]=n=>h.value.content=n),placeholder:"通知内容",rows:"4",disabled:T.value.length>=3,class:"w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary resize-none disabled:bg-gray-100"},null,8,Hs),[[fe,h.value.content]]),s("button",{onClick:Mt,disabled:!h.value.title||!h.value.content||T.value.length>=3,class:"w-full mt-4 py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50"}," 发布通知 ",8,zs)]),s("div",Rs,[s("h3",Os,"已发布通知 ("+i(T.value.length)+"/3)",1),T.value.length>0?(o(),r("div",Ws,[(o(!0),r(F,null,Q(T.value,n=>(o(),r("div",{key:n.id,class:y(["border-l-2 pl-3 relative",n.is_pinned?"border-primary bg-primary-light":"border-primary"])},[s("div",Xs,[s("div",Ys,[s("div",Gs,[s("span",Js,i(n.title),1),n.is_pinned?(o(),r("span",Ks,"置顶")):u("",!0)]),s("div",Zs,i(n.content),1),s("div",en,i($(R)(n.created_at)),1)]),s("div",tn,[s("button",{onClick:d=>At(n.id),class:y(["px-3 py-1 text-xs rounded",n.is_pinned?"bg-gray-100 text-gray-600":"bg-primary-light text-primary"])},i(n.is_pinned?"取消置顶":"置顶"),11,sn),s("button",{onClick:d=>$t(n.id),class:"px-3 py-1 bg-gray-100 text-gray-700 text-xs rounded"}," 删除 ",8,nn)])])],2))),128))])):(o(),r("div",an," 暂无通知 "))])])):u("",!0),l.value==="cards"&&U.value?(o(),r("div",on,[de.value?(o(),r("div",rn,i(de.value),1)):u("",!0),p.value?(o(),r("div",{key:1,ref_key:"userCodeAnchor",ref:Be,class:"bg-white rounded-xl p-4 shadow-sm mb-4 flex items-center justify-between"},[e[38]||(e[38]=s("div",{class:"text-sm text-gray-700"},"当前仅显示该用户的卡片",-1)),s("button",{type:"button",class:"text-sm text-primary",onClick:ht},"清除筛选")],512)):u("",!0),s("div",ln,[s("div",{class:y(["grid grid-cols-1 gap-3",f.value?"sm:grid-cols-2":""])},[f.value?re((o(),r("input",{key:0,"onUpdate:modelValue":e[14]||(e[14]=n=>M.value.card_no=n),class:"border border-gray-200 rounded-lg px-3 py-2 text-sm",placeholder:"按卡号搜索"},null,512)),[[fe,M.value.card_no]]):u("",!0),re(s("select",{"onUpdate:modelValue":e[15]||(e[15]=n=>M.value.card_type=n),class:"border border-gray-200 rounded-lg px-3 py-2 text-sm"},[e[39]||(e[39]=s("option",{value:""},"全部卡片类型",-1)),(o(!0),r(F,null,Q(Te.value,n=>(o(),r("option",{key:n.id,value:n.name},i(n.name)+"（"+i(Ee(n.card_type))+"） ",9,un))),128))],512),[[Ot,M.value.card_type]])],2),s("div",{class:y(["flex gap-2 mt-3 items-center",f.value?"":"justify-start"])},[f.value?(o(),r("button",{key:0,onClick:ft,class:"px-4 py-2 bg-primary text-white text-sm rounded-lg"}," 查询 ")):u("",!0),f.value?(o(),r("button",{key:1,onClick:xt,class:"px-4 py-2 bg-gray-100 text-gray-700 text-sm rounded-lg"}," 重置 ")):u("",!0),f.value?(o(),r("div",cn)):u("",!0),!Y()&&m.value.support_direct_sale||Y()&&Le.value?(o(),r("button",{key:3,type:"button",onClick:Oe,class:"px-4 py-2 bg-slate-600 text-white text-sm rounded-lg"}," 售卡 ")):u("",!0)],2)]),ee.value==="cards"&&ce.value?(o(),r("div",dn," 加载中... ")):ee.value==="cards"?(o(),r("div",vn,[(o(!0),r(F,null,Q(K.value,(n,d)=>{var v,C;return o(),r("div",{key:n.id,class:"mb-6"},[s("div",{onClick:E=>wt(n.id),class:y(["rounded-2xl p-4 cursor-pointer transition-transform active:scale-[0.98]","kb-card"])},[s("div",yn,[s("div",null,[s("h3",gn,i(((v=n.user)==null?void 0:v.nickname)||n.user_id),1),s("p",fn,i(n.card_type),1)]),s("div",pn,[s("span",xn,"NO: "+i(n.card_no||"-"),1)])]),s("div",hn,[s("div",null,[e[40]||(e[40]=s("div",{class:"text-gray-500 text-xs mb-0.5"},"剩余次数",-1)),s("div",bn,i(n.remain_times),1)]),s("div",_n,[e[41]||(e[41]=s("div",{class:"text-gray-500 text-xs mb-0.5"},"有效期至",-1)),s("div",wn,i($(qe)(n.end_date)),1)])])],8,mn),ve.value===n.id?(o(),r("div",kn,[s("div",Cn,[s("div",Tn,[e[42]||(e[42]=s("span",{class:"text-gray-500"},"用户",-1)),s("span",Sn,i(((C=n.user)==null?void 0:C.nickname)||n.user_id),1)]),s("div",Mn,[e[43]||(e[43]=s("span",{class:"text-gray-500"},"卡类型",-1)),s("span",$n,i(n.card_type),1)]),s("div",An,[e[44]||(e[44]=s("span",{class:"text-gray-500"},"开卡/充值",-1)),s("span",Dn,i($(R)(n.recharge_at))+" / ¥"+i(n.recharge_amount),1)]),s("div",In,[e[45]||(e[45]=s("span",{class:"text-gray-500"},"总次数",-1)),s("span",jn,i(n.total_times)+" 次",1)]),s("div",qn,[e[46]||(e[46]=s("span",{class:"text-gray-500"},"已使用",-1)),s("span",Un,i(n.used_times)+" 次",1)]),s("div",Nn,[e[47]||(e[47]=s("span",{class:"text-gray-500"},"上次使用",-1)),s("span",Pn,i(n.last_used_at?$(R)(n.last_used_at):"未使用"),1)]),s("div",Vn,[e[48]||(e[48]=s("span",{class:"text-gray-500"},"有效期",-1)),s("span",Bn,i($(qe)(n.start_date))+" 至 "+i($(qe)(n.end_date)),1)])])])):u("",!0)])}),128)),K.value.length>0&&K.value.length<=2?(o(),r("div",{key:0,style:Wt({height:bt()})},null,4)):u("",!0),K.value.length===0?(o(),r("div",Fn," 暂无已发卡 ")):u("",!0)])):u("",!0),ee.value==="sellTemplates"?(o(),r("div",Qn,[Z.value.length===0?(o(),r("div",Ln," 暂无在售卡片模板 ")):(o(),r("div",En,[(o(!0),r(F,null,Q(Z.value,n=>(o(),r("div",{key:n.id,class:"template-item"},[s("div",{class:"template-card",onClick:d=>pt(n)},[s("div",zn,[s("div",Rn,i(n.name),1),s("div",On,[s("span",Wn,i(Ee(n.card_type)),1),s("span",Xn,"¥"+i((n.price/100).toFixed(2)),1)]),s("div",Yn,[n.card_type!=="balance"?(o(),r("span",Gn,i(n.total_times)+"次",1)):(o(),r("span",Jn,"充值"+i((n.recharge_amount/100).toFixed(0))+"元",1)),n.valid_days>0?(o(),r("span",Kn,"· "+i(n.valid_days)+"天有效",1)):(o(),r("span",Zn,"· 永久有效"))])])],8,Hn)]))),128))]))])):u("",!0)])):u("",!0),te.value?(o(),r("div",{key:5,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[17]||(e[17]=z(n=>te.value=!1,["self"]))},[s("div",ea,[e[49]||(e[49]=s("div",{class:"px-5 py-4 border-b"},[s("h3",{class:"font-medium text-lg text-gray-800"},"切换营业状态")],-1)),s("div",ta,[s("p",sa,i(m.value.is_open?"确定要切换为打烊状态吗？":"确定要切换为营业中状态吗？"),1),s("div",na,[s("button",{onClick:e[16]||(e[16]=n=>te.value=!1),class:"flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors"}," 取消 "),s("button",{onClick:Dt,class:y(["flex-1 py-2.5 rounded-lg font-medium transition-colors",m.value.is_open?"bg-red-500 text-white hover:bg-red-600":"bg-green-500 text-white hover:bg-green-600"])},i(m.value.is_open?"确认打烊":"确认营业"),3)])])])])):u("",!0),we.value?(o(),r("div",{key:6,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 select-none",onClick:z(We,["self"])},[s("div",aa,[s("div",oa,[s("h3",ra,i(ut())+"的售卡二维码",1),s("button",{onClick:We,class:"text-white"},[...e[50]||(e[50]=[s("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),s("div",la,[s("div",ia,[s("div",ua,i(lt.value),1),e[51]||(e[51]=s("div",{class:"text-gray-500 text-sm mt-1"},"请客户扫码购买",-1))]),s("div",ca,[s("div",{class:"select-none",style:{"-webkit-touch-callout":"none","-webkit-user-select":"none","user-select":"none","pointer-events":"none","touch-action":"none"},onTouchstart:e[18]||(e[18]=z(()=>{},["prevent"])),onTouchmove:e[19]||(e[19]=z(()=>{},["prevent"])),onTouchend:e[20]||(e[20]=z(()=>{},["prevent"])),onContextmenu:e[21]||(e[21]=z(()=>{},["prevent"]))},[s("canvas",{ref_key:"sellQrCanvas",ref:Fe,class:"w-56 h-56",style:{"-webkit-touch-callout":"none"}},null,512)],32)]),e[52]||(e[52]=s("div",{class:"mt-4 text-center text-gray-400 text-xs"}," 请向客户出示此二维码用于购买卡片 ",-1))])])])):u("",!0)])}}},xa=Kt(da,[["__scopeId","data-v-d96b2b5e"]]);export{xa as default};
