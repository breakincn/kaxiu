import{e as c,p as K,q as Z,s as tt,x as et,f as p,g as e,n as N,j as A,k as E,r as st,t as r,y as C,F as nt,z as ot,w as m,u as at,o as v,A as rt,B as lt}from"./vendor.Da2sdW28.js";import{c as it,n as ct,b as dt}from"./index.DuRPLurf.js";import{f as ut}from"./dateFormat.BMJ2_UIx.js";import{Q as pt}from"./browser.DZr5NsCX.js";import"./index.BYIGvkoh.js";const vt={class:"min-h-screen bg-gray-50"},xt={class:"bg-white px-4 py-3 flex items-center justify-between border-b"},mt={class:"flex items-center gap-3"},yt={class:"px-4 py-6"},ft={class:"flex items-center gap-3"},ht={class:"text-xl font-bold text-gray-800"},gt={class:"px-4 mb-4"},bt={class:"flex items-center justify-between"},_t={class:"flex gap-2"},kt={class:"px-4 pb-6 space-y-4"},wt=["onClick","onTouchstart"],Ct={class:"flex justify-between items-start mb-1"},Tt={class:"text-lg font-bold"},St={class:"text-gray-500 text-xs mt-0.5"},Mt={class:"text-5xl font-bold leading-none"},$t={class:"text-right"},Nt={class:"text-sm font-medium"},jt=["onClick"],Dt={class:"flex items-center gap-2 mb-1"},It={class:"text-red-600 font-medium text-xs truncate flex-1"},Ut={class:"text-red-500 text-xs line-clamp-2 pl-5"},Bt={key:1,class:"rounded-2xl p-4 card-gradient-yellow cursor-not-allowed"},Lt={class:"flex justify-between items-start mb-2"},Qt={class:"text-lg font-bold text-gray-800"},Pt={class:"text-gray-600 text-xs mt-0.5"},zt={class:"bg-white/80 px-2.5 py-0.5 rounded-full"},At={class:"text-xs font-medium text-gray-700"},Et={class:"flex justify-between items-end mt-6"},Vt={class:"flex items-end gap-2"},Ft={class:"text-xs text-gray-600 pb-0.5"},Ot={class:"text-right"},Rt={class:"text-gray-600 text-xs mb-0.5"},Ht={class:"text-gray-600 text-xs mb-0.5"},Yt={class:"text-sm font-medium text-yellow-800"},Xt={key:0,class:"text-center py-12 text-gray-400"},qt={class:"bg-white rounded-2xl w-11/12 max-w-lg overflow-hidden"},Gt={class:"px-5 py-5"},Wt={class:"text-center"},Jt={class:"text-gray-800 font-medium"},Kt={class:"text-gray-500 text-sm mt-1"},Zt={class:"mt-4 flex justify-center"},le={__name:"CardList",setup(te){const f=at(),j=c(""),u=c("active"),D=c([]),h=c([]),g=c(null),T=c(!1),b=c(null),S=c(null),_=c(null),x={userSelect:"",webkitUserSelect:"",webkitTouchCallout:""};let i=null,y=null;const I=c(0),V=()=>{try{"vibrate"in navigator&&typeof navigator.vibrate=="function"&&navigator.vibrate(35)}catch{}},U=c(Date.now());let k=null,w=null;const F=()=>{const s=localStorage.getItem("userId"),t=localStorage.getItem("userName");if(!s){f.push("/login");return}g.value=parseInt(s),j.value=t||"ç”¨æˆ·"},M=async()=>{if(g.value){if(u.value!=="active"){h.value=[];return}try{const t=(await dt.getDirectPurchases()).data.data||[];h.value=t.filter(a=>a&&a.status==="paid")}catch(s){console.error("è·å–å¾…ç¡®è®¤è®¢å•å¤±è´¥:",s),h.value=[]}}},B=K(()=>{var t,a;const s=[];for(const o of h.value||[])s.push({_type:"pending",_key:`pending-${o.order_no}`,order_no:o.order_no,paid_at:o.paid_at,payment_method:o.payment_method,price:o.price,merchant_name:((t=o.merchant)==null?void 0:t.name)||"å•†æˆ·",card_name:((a=o.card_template)==null?void 0:a.name)||"å¡ç‰‡"});for(const o of D.value||[])s.push({...o,_type:"card",_key:`card-${o.id}`});return s}),$=async()=>{var s;if(g.value)try{const a=(await it.getUserCards(g.value,u.value)).data.data||[];for(const o of a)if(o.merchant_id)try{const d=(await ct.getMerchantNotices(o.merchant_id,3)).data.data||[];o.pinnedNotice=d.find(n=>n.is_pinned)||null}catch(l){console.error("è·å–é€šçŸ¥å¤±è´¥:",l),o.pinnedNotice=null}D.value=a}catch(t){console.error("è·å–å¡ç‰‡å¤±è´¥:",t),((s=t.response)==null?void 0:s.status)===401&&f.push("/login")}},O=s=>{f.push(`/user/cards/${s}`)},R=s=>{f.push(`/user/cards/${s}?scrollToNotice=1`)},H=s=>{Date.now()<I.value||O(s)},Y=s=>{!s||!s.id||(i&&(clearTimeout(i),i=null),_.value=s.id,y=null,i=setTimeout(async()=>{I.value=Date.now()+900,V(),await q(s)},820))},X=s=>{var l;if(!i)return;const t=(l=s==null?void 0:s.touches)==null?void 0:l[0];if(!t)return;if(!y){y={x:t.clientX,y:t.clientY};return}const a=t.clientX-y.x,o=t.clientY-y.y;a*a+o*o>144&&(clearTimeout(i),i=null,_.value=null)},L=()=>{i&&(clearTimeout(i),i=null),_.value=null},q=async s=>{b.value=s,T.value=!0;try{x.userSelect=document.body.style.userSelect,x.webkitUserSelect=document.body.style.webkitUserSelect,x.webkitTouchCallout=document.body.style.webkitTouchCallout,document.documentElement.classList.add("kb-no-select"),document.body.classList.add("kb-no-select"),document.body.style.userSelect="none",document.body.style.webkitUserSelect="none",document.body.style.webkitTouchCallout="none"}catch{}try{const t=`kabao-card:${s.id}`;await lt(),S.value&&await pt.toCanvas(S.value,t,{margin:1,scale:8,errorCorrectionLevel:"M"})}catch{}},Q=()=>{T.value=!1,b.value=null;try{document.documentElement.classList.remove("kb-no-select"),document.body.classList.remove("kb-no-select"),document.body.style.userSelect=x.userSelect,document.body.style.webkitUserSelect=x.webkitUserSelect,document.body.style.webkitTouchCallout=x.webkitTouchCallout}catch{}};function G(s){if(!s)return"";const t=new Date(s).getTime();if(!t)return"";const a=Math.max(0,Math.floor((U.value-t)/1e3)),o=Math.floor(a/3600),l=Math.floor(a%3600/60),d=a%60;return o>0?`${o}å°æ—¶${l}åˆ†${d}ç§’`:l>0?`${l}åˆ†${d}ç§’`:`${d}ç§’`}function W(s){return s?{wechat:"å¾®ä¿¡æ”¯ä»˜",alipay:"æ”¯ä»˜å®",unionpay:"é“¶è”æ”¯ä»˜",cash:"ç°é‡‘æ”¯ä»˜"}[s]||s:"æœªçŸ¥æ”¯ä»˜æ–¹å¼"}function J(s){if(!s)return"";const t=new Date(s);if(isNaN(t.getTime()))return"";const a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),d=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");return`${a}-${o}-${l} ${d}:${n}`}return Z(u,async()=>{await $(),await M()}),tt(()=>{F(),$(),M(),k=setInterval(()=>{U.value=Date.now()},1e3),w=setInterval(()=>{$(),M()},8e3)}),et(()=>{k&&(clearInterval(k),k=null),w&&(clearInterval(w),w=null),i&&(clearTimeout(i),i=null)}),(s,t)=>{var o,l,d;const a=st("router-link");return v(),p("div",vt,[e("header",xt,[t[8]||(t[8]=e("div",{class:"flex items-center gap-2"},[e("span",{class:"text-primary font-bold text-xl"},"å¡åŒ…"),e("span",{class:"text-gray-400 text-xs"},"kabao.app")],-1)),e("div",mt,[A(a,{to:"/user/scan-pay",class:"p-1 text-gray-500 hover:text-primary"},{default:E(()=>[...t[6]||(t[6]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 4h-1a2 2 0 00-2 2v1m0 10v1a2 2 0 002 2h1m10-16h1a2 2 0 012 2v1m0 10v1a2 2 0 01-2 2h-1"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 11h8m-8 4h8"})],-1)])]),_:1}),A(a,{to:"/user/settings",class:"p-1 text-gray-500 hover:text-primary"},{default:E(()=>[...t[7]||(t[7]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1)])]),_:1})])]),e("div",yt,[e("div",ft,[t[10]||(t[10]=e("span",{class:"text-3xl"},"ğŸ‘‹",-1)),e("div",null,[e("h1",ht,"ä½ å¥½ï¼Œ"+r(j.value),1),t[9]||(t[9]=e("p",{class:"text-gray-500 text-sm"},"ä»Šå¤©æƒ³å»å“ªé‡Œäº«å—æœåŠ¡ï¼Ÿ",-1))])])]),e("div",gt,[e("div",bt,[t[11]||(t[11]=e("h2",{class:"text-lg font-bold text-gray-800"},"æˆ‘çš„å¡ç‰‡",-1)),e("div",_t,[e("button",{onClick:t[0]||(t[0]=n=>u.value="active"),class:C(["px-4 py-1.5 rounded-full text-sm font-medium transition-all",u.value==="active"?"bg-primary text-white":"bg-gray-100 text-gray-500"])}," è¿›è¡Œä¸­ ",2),e("button",{onClick:t[1]||(t[1]=n=>u.value="expired"),class:C(["px-4 py-1.5 rounded-full text-sm font-medium transition-all",u.value==="expired"?"bg-gray-600 text-white":"bg-gray-100 text-gray-500"])}," å·²å¤±æ•ˆ ",2)])])]),e("div",kt,[(v(!0),p(nt,null,ot(B.value,(n,ee)=>{var P;return v(),p("div",{key:n._key},[n._type==="card"?(v(),p("div",{key:0,onClick:z=>H(n.id),onTouchstart:z=>Y(n),onTouchmove:X,onTouchend:L,onTouchcancel:L,class:C(["rounded-2xl p-4 cursor-pointer transition-transform active:scale-[0.98]",_.value===n.id?"scale-[0.985] opacity-90":"","select-none","kb-card"]),style:{"-webkit-touch-callout":"none"}},[e("div",Ct,[e("div",null,[e("h3",Tt,r((P=n.merchant)==null?void 0:P.name),1),e("p",St,r(n.card_type),1)]),t[12]||(t[12]=e("div",{class:"bg-gray-100 px-2.5 py-0.5 rounded-full"},[e("span",{class:"text-xs font-medium"},"NO: G12345678981189")],-1))]),e("div",{class:C(["flex justify-between items-end",n.pinnedNotice?"mb-2":"mb-6"])},[e("div",null,[t[13]||(t[13]=e("div",{class:"text-gray-500 text-xs mb-0.5"},"å‰©ä½™æ¬¡æ•°",-1)),e("div",Mt,r(n.remain_times),1)]),e("div",$t,[t[14]||(t[14]=e("div",{class:"text-gray-500 text-xs mb-0.5"},"æœ‰æ•ˆæœŸè‡³",-1)),e("div",Nt,r(rt(ut)(n.end_date)),1)])],2),n.pinnedNotice?(v(),p("div",{key:0,class:"pt-2 border-t border-gray-100",onClick:m(z=>R(n.id),["stop"])},[e("div",Dt,[t[15]||(t[15]=e("svg",{class:"w-3 h-3 text-red-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})],-1)),e("span",It,r(n.pinnedNotice.title),1),t[16]||(t[16]=e("span",{class:"px-1.5 py-0.5 bg-red-500 text-white text-xs rounded flex-shrink-0"},"ç½®é¡¶",-1))]),e("div",Ut,r(n.pinnedNotice.content),1)],8,jt)):N("",!0)],42,wt)):(v(),p("div",Bt,[e("div",Lt,[e("div",null,[e("h3",Qt,r(n.merchant_name),1),e("p",Pt,r(n.card_name),1)]),e("div",zt,[e("span",At,"NO: "+r(n.order_no),1)])]),e("div",Et,[e("div",Vt,[t[17]||(t[17]=e("div",null,[e("div",{class:"text-gray-600 text-xs mb-0.5"},"å¡ç‰‡çŠ¶æ€"),e("div",{class:"text-xl font-bold text-gray-800"},"å¾…å•†å®¶ç¡®è®¤")],-1)),e("div",Ft,r(W(n.payment_method)),1)]),e("div",Ot,[e("div",Rt,r(J(n.paid_at)),1),e("div",Ht,"å·²ä»˜æ¬¾ Â¥"+r((n.price/100).toFixed(2)),1),e("div",Yt,r(G(n.paid_at)),1)])])]))])}),128)),B.value.length===0?(v(),p("div",Xt," æš‚æ— "+r(u.value==="active"?"æœ‰æ•ˆ":"å¤±æ•ˆ")+"å¡ç‰‡ ",1)):N("",!0)]),T.value?(v(),p("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 select-none",onClick:m(Q,["self"])},[e("div",qt,[e("div",{class:"bg-primary text-white px-5 py-4 flex items-center justify-between"},[t[19]||(t[19]=e("h3",{class:"font-medium text-lg"},"å¡ç‰‡äºŒç»´ç ",-1)),e("button",{onClick:Q,class:"text-white"},[...t[18]||(t[18]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",Gt,[e("div",Wt,[e("div",Jt,r(((l=(o=b.value)==null?void 0:o.merchant)==null?void 0:l.name)||"å•†æˆ·"),1),e("div",Kt,r(((d=b.value)==null?void 0:d.card_type)||""),1)]),e("div",Zt,[e("div",{class:"select-none",style:{"-webkit-touch-callout":"none","-webkit-user-select":"none","user-select":"none","pointer-events":"none","touch-action":"none"},onTouchstart:t[2]||(t[2]=m(()=>{},["prevent"])),onTouchmove:t[3]||(t[3]=m(()=>{},["prevent"])),onTouchend:t[4]||(t[4]=m(()=>{},["prevent"])),onContextmenu:t[5]||(t[5]=m(()=>{},["prevent"]))},[e("canvas",{ref_key:"cardQrCanvas",ref:S,class:"w-56 h-56",style:{"-webkit-touch-callout":"none"}},null,512)],32)]),t[20]||(t[20]=e("div",{class:"mt-4 text-center text-gray-400 text-xs"}," è¯·å‘å•†æˆ·å‡ºç¤ºæ­¤äºŒç»´ç ç”¨äºæŸ¥è¯¢å¡ç‰‡ ",-1))])])])):N("",!0)])}}};export{le as default};
