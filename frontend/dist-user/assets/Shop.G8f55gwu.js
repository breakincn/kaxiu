import{e as c,m as ge,p as ee,s as be,D as we,f as s,g as a,F as ae,n as p,t as i,z as ke,w as R,y as w,i as te,v as le,u as Ce,o as n}from"./vendor.Da2sdW28.js";import{a as xe,b as j,s as Pe,f as Ie}from"./index.DuRPLurf.js";import{_ as $e}from"./index.BYIGvkoh.js";const Te={class:"shop-page"},Be={key:0,class:"loading-state"},Fe={key:1,class:"error-state"},Me={class:"shop-header"},Se={class:"merchant-avatar"},Ae={class:"merchant-info"},qe={class:"merchant-name"},De={class:"merchant-type"},Ue={class:"card-section"},je={key:0,class:"empty-cards"},Le={key:1,class:"card-list"},Ne=["onClick"],Ve={class:"card-content"},ze={class:"card-name"},Re={class:"card-meta"},Ee={class:"card-type"},Ge={key:0,class:"card-times"},He={key:1,class:"card-amount"},Oe={key:0,class:"card-desc"},Je={class:"card-validity"},Ke={class:"card-price"},Qe={class:"price-value"},We={class:"modal purchase-modal"},Xe={class:"modal-body"},Ye={class:"purchase-card-info"},Ze={class:"purchase-card-name"},ea={class:"purchase-card-meta"},aa={key:0},ta={key:1},la={class:"purchase-price"},sa={class:"price-value"},na={key:0,class:"login-prompt"},oa={key:1,class:"payment-methods"},ia={class:"payment-options"},ua={key:0,style:{"margin-bottom":"16px"}},ra={key:1,class:"purchase-scan-guide"},ca=["disabled"],da={class:"modal purchase-modal"},va={class:"modal-body"},pa={class:"mb-4"},ma={class:"mb-4"},ya={class:"flex gap-2"},fa=["disabled"],ha=["disabled"],_a={class:"modal payment-modal"},ga={class:"modal-header"},ba={class:"payment-title"},wa={class:"modal-body"},ka={class:"payment-info"},Ca={class:"amount"},xa={key:0,class:"qrcode-container"},Pa=["src"],Ia=["disabled"],$a={class:"payment-guide-text"},Ta={key:0,class:"payment-actions"},Ba=["disabled"],Fa={key:3,class:"modal-overlay"},Ma={__name:"Shop",setup(Sa){const k=we(),E=Ce(),L=c(!0),d=c(null),m=c(null),$=c(!1),T=c(!1),G=c(!1),B=c(null),F=c(!1),M=c(!1),S=c(!1),y=c({phone:"",code:""});function C(t){if(t){u.value=t;try{t==="alipay"?window.location.href="alipayqr://platformapi/startapp?saId=10000007":window.location.href="weixin://"}catch{}}}const b=c(0);let h=null;const A=c(null),u=c(""),g=c(""),f=c(null),q=c(!1),D=c(!1),H=c(null);function se(){var o;const t=(o=k.query)==null?void 0:o.tech_id;if(!t)return null;const e=parseInt(String(t),10);return Number.isFinite(e)&&e>0?e:null}function ne(){var o;const t=(o=k.query)==null?void 0:o.card_template_id;if(!t)return null;const e=parseInt(String(t),10);return Number.isFinite(e)&&e>0?e:null}const x=c(!0),P=c(!1),U=c(!1),I=c(!1);let v=null;ge(()=>{v&&(clearTimeout(v),v=null),h&&(clearInterval(h),h=null)});const N=ee(()=>!!localStorage.getItem("userToken")),oe=ee(()=>{const t=m.value;if(!t)return"å®Œæˆä»˜æ¬¾";if(t.card_type==="balance")return`${t.name} å……${(t.recharge_amount/100).toFixed(0)}å…ƒ`;const e=t.card_type==="lesson"?"è¯¾æ—¶":"æ¬¡";return`${t.name} ${t.total_times}${e}`});be(()=>{ve(),N.value&&O()});async function O(){try{const t=await xe.getCurrentUser();B.value=t.data.data}catch{B.value=null}}function ie(t){return!!(t&&t.phone)}function J(){F.value=!1,y.value={phone:"",code:""},b.value=0,h&&(clearInterval(h),h=null),A.value=null}function ue(){b.value=60,h=setInterval(()=>{b.value-=1,b.value<=0&&(clearInterval(h),h=null)},1e3)}async function re(){var t,e,o,r;if(!y.value.phone){alert("è¯·å…ˆè¾“å…¥æ‰‹æœºå·");return}S.value=!0;try{const _=(e=(t=(await Pe.send(y.value.phone,"user_bind_phone")).data)==null?void 0:t.data)==null?void 0:e.debug_code;alert(_?`éªŒè¯ç å·²å‘é€ï¼ˆå¼€å‘æ¨¡å¼ï¼‰ï¼š${_}`:"éªŒè¯ç å·²å‘é€"),ue()}catch(l){alert(((r=(o=l.response)==null?void 0:o.data)==null?void 0:r.error)||"å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{S.value=!1}}async function ce(){var t,e;if(!y.value.phone){alert("è¯·è¾“å…¥æ‰‹æœºå·");return}if(!y.value.code){alert("è¯·è¾“å…¥éªŒè¯ç ");return}M.value=!0;try{const o=await Ie.bindPhone(y.value.phone,y.value.code);B.value=o.data.data,F.value=!1;const r=A.value;A.value=null,y.value={phone:"",code:""},r&&await r()}catch(o){alert(((e=(t=o.response)==null?void 0:t.data)==null?void 0:e.error)||"ç»‘å®šå¤±è´¥ï¼Œè¯·é‡è¯•")}finally{M.value=!1}}async function de(t){return!N.value||(await O(),ie(B.value))?!0:(F.value=!0,A.value=t||null,!1)}async function ve(){var t;L.value=!0;try{const e=k.params.slug,o=k.params.id;let r;if(e)r=await j.getShopInfo(e);else if(o)r=await j.getShopInfoByID(o);else{d.value=null;return}d.value=r.data.data,H.value=se();const l=ne();if(l){const _=(((t=d.value)==null?void 0:t.card_templates)||[]).find(Z=>Z&&Z.id===l);_&&Q(_)}}catch(e){console.error("åŠ è½½åº—é“ºä¿¡æ¯å¤±è´¥",e),d.value=null}finally{L.value=!1}}function K(t){return{times:"æ¬¡æ•°å¡",lesson:"è¯¾æ—¶å¡",balance:"å……å€¼å¡"}[t]||t}function Q(t){m.value=t,u.value=Y(),$.value=!0}function W(t){u.value===t?V():u.value=t}function X(){$.value=!1,m.value=null}function pe(){localStorage.setItem("redirectAfterLogin",k.fullPath),E.push("/login")}async function V(){var e,o;if(u.value||(u.value=Y()),!u.value){alert("å•†æˆ·æœªé…ç½®æ”¶æ¬¾æ–¹å¼");return}if(await de(V)){q.value=!0;try{const r=await j.createDirectPurchase({card_template_id:m.value.id,seller_technician_id:H.value,payment_method:u.value});f.value=r.data.data,g.value=r.data.data.payment_url,x.value=!0,P.value=!1,v&&(clearTimeout(v),v=null),$.value=!1,T.value=!0}catch(r){alert(((o=(e=r.response)==null?void 0:e.data)==null?void 0:o.error)||"åˆ›å»ºè®¢å•å¤±è´¥")}finally{q.value=!1}}}function me(t){return t?t.match(/\.(jpg|jpeg|png|gif|webp)$/i)||t.includes("qr")||t.includes("code"):!1}function Y(){var e;const t=(e=d.value)==null?void 0:e.payment_config;return t?t.default_method==="alipay"&&t.has_alipay?"alipay":t.default_method==="wechat"&&t.has_wechat?"wechat":t.has_alipay?"alipay":t.has_wechat?"wechat":"":""}async function ye(){if(g.value){try{const e=await(await fetch(g.value)).blob(),r={"image/png":"png","image/jpeg":"jpg","image/webp":"webp"}[e.type]||"jpg",l=`payment_qrcode_${Date.now()}.${r}`;if(navigator.share&&window.File)try{const _=new File([e],l,{type:e.type||"image/jpeg"});await navigator.share({files:[_],title:"æ”¶æ¬¾ç "})}catch{console.log("åˆ†äº«å¤±è´¥æˆ–å–æ¶ˆ")}else console.log("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½")}catch{console.log("è·å–å›¾ç‰‡å¤±è´¥")}U.value=!0,I.value=!0}}function fe(){if(!I.value)return;const t=u.value==="alipay";try{t?window.location.href="alipayqr://platformapi/startapp?saId=10000007":window.location.href="weixin://"}catch{}v&&(clearTimeout(v),v=null),v=setTimeout(()=>{x.value=!1,P.value=!0,v=null},15e3)}function z(){T.value=!1,f.value=null,g.value="",x.value=!0,P.value=!1,U.value=!1,I.value=!1,v&&(clearTimeout(v),v=null)}async function he(){var t,e;if(f.value){if(!f.value.order_no){alert("è®¢å•ä¿¡æ¯ç¼ºå¤±ï¼Œè¯·é‡æ–°å‘èµ·è´­ä¹°");return}if(!f.value.card_template_id){alert("å¡ç‰‡ä¿¡æ¯ç¼ºå¤±ï¼Œè¯·é‡æ–°å‘èµ·è´­ä¹°");return}if(!f.value.payment_method){alert("æ”¯ä»˜æ–¹å¼ç¼ºå¤±ï¼Œè¯·é‡æ–°é€‰æ‹©æ”¯ä»˜æ–¹å¼");return}D.value=!0;try{await j.confirmDirectPurchase(f.value.order_no,{card_template_id:f.value.card_template_id,seller_technician_id:f.value.seller_technician_id,payment_method:f.value.payment_method}),T.value=!1,G.value=!0,x.value=!0,P.value=!1,U.value=!1,I.value=!1,v&&(clearTimeout(v),v=null)}catch(o){const r=((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.error)||(o==null?void 0:o.message)||"",l=r&&String(r).toLowerCase().includes("eof")?"æäº¤å¤±è´¥ï¼šè¯·æ±‚å‚æ•°å¼‚å¸¸ï¼Œè¯·é‡æ–°å‘èµ·è´­ä¹°":r||"æäº¤å¤±è´¥";alert(l)}finally{D.value=!1}}}function _e(){E.push("/user/cards")}return(t,e)=>{var o,r;return n(),s("div",Te,[L.value?(n(),s("div",Be,[...e[9]||(e[9]=[a("div",{class:"spinner"},null,-1),a("p",null,"åŠ è½½ä¸­...",-1)])])):d.value?(n(),s(ae,{key:2},[a("div",Me,[a("div",Se,i(d.value.merchant.name.charAt(0)),1),a("div",Ae,[a("h1",qe,i(d.value.merchant.name),1),a("p",De,i(d.value.merchant.type),1)])]),a("div",Ue,[e[13]||(e[13]=a("h2",{class:"section-title"},"åœ¨å”®å¡ç‰‡",-1)),d.value.card_templates.length===0?(n(),s("div",je,[...e[11]||(e[11]=[a("p",null,"æš‚æ— åœ¨å”®å¡ç‰‡",-1)])])):(n(),s("div",Le,[(n(!0),s(ae,null,ke(d.value.card_templates,l=>(n(),s("div",{key:l.id,class:"card-item",onClick:_=>Q(l)},[a("div",Ve,[a("div",ze,i(l.name),1),a("div",Re,[a("span",Ee,i(K(l.card_type)),1),l.card_type!=="balance"?(n(),s("span",Ge,i(l.total_times)+"æ¬¡",1)):(n(),s("span",He,"å……"+i((l.recharge_amount/100).toFixed(0))+"å…ƒ",1))]),l.description?(n(),s("div",Oe,i(l.description),1)):p("",!0),a("div",Je,i(l.valid_days>0?`${l.valid_days}å¤©æœ‰æ•ˆ`:"æ°¸ä¹…æœ‰æ•ˆ"),1)]),a("div",Ke,[e[12]||(e[12]=a("span",{class:"price-label"},"Â¥",-1)),a("span",Qe,i((l.price/100).toFixed(2)),1)])],8,Ne))),128))]))]),$.value?(n(),s("div",{key:0,class:"modal-overlay",onClick:R(X,["self"])},[a("div",We,[a("div",{class:"modal-header"},[e[14]||(e[14]=a("h3",null,"ç¡®è®¤è´­ä¹°",-1)),a("button",{class:"close-btn",onClick:X},"Ã—")]),a("div",Xe,[a("div",Ye,[a("div",Ze,i(m.value.name),1),a("div",ea,[a("span",null,i(K(m.value.card_type)),1),m.value.card_type!=="balance"?(n(),s("span",aa,"Â· "+i(m.value.total_times)+"æ¬¡",1)):(n(),s("span",ta,"Â· å……"+i((m.value.recharge_amount/100).toFixed(0))+"å…ƒ",1)),a("span",null,"Â· "+i(m.value.valid_days>0?`${m.value.valid_days}å¤©æœ‰æ•ˆ`:"æ°¸ä¹…æœ‰æ•ˆ"),1)]),a("div",la,[e[15]||(e[15]=a("span",{class:"price-label"},"Â¥",-1)),a("span",sa,i((m.value.price/100).toFixed(2)),1)])]),N.value?(n(),s("div",oa,[e[19]||(e[19]=a("h4",null,"é€‰æ‹©æ”¯ä»˜æ–¹å¼",-1)),a("div",ia,[d.value.payment_config.has_alipay?(n(),s("div",{key:0,class:w(["payment-option",{selected:u.value==="alipay"}]),onClick:e[0]||(e[0]=l=>W("alipay"))},[...e[17]||(e[17]=[a("div",{class:"payment-icon alipay"},"æ”¯",-1),a("span",null,"æ”¯ä»˜å®",-1)])],2)):p("",!0),d.value.payment_config.has_wechat?(n(),s("div",{key:1,class:w(["payment-option",{selected:u.value==="wechat"}]),onClick:e[1]||(e[1]=l=>W("wechat"))},[...e[18]||(e[18]=[a("div",{class:"payment-icon wechat"},"å¾®",-1),a("span",null,"å¾®ä¿¡æ”¯ä»˜",-1)])],2)):p("",!0)]),!d.value.payment_config.has_alipay||!d.value.payment_config.has_wechat?(n(),s("div",ua,[d.value.payment_config.has_alipay?p("",!0):(n(),s("button",{key:0,class:"purchase-btn",type:"button",onClick:e[2]||(e[2]=l=>C("alipay")),style:{"margin-bottom":"10px"}}," æ”¯ä»˜å®æ‰«ç æ”¯ä»˜ ")),d.value.payment_config.has_wechat?p("",!0):(n(),s("button",{key:1,class:"purchase-btn",type:"button",onClick:e[3]||(e[3]=l=>C("wechat"))}," å¾®ä¿¡æ‰«ç æ”¯ä»˜ "))])):p("",!0),e[20]||(e[20]=a("div",{class:"purchase-tip"},[a("p",null,"ğŸ’¡ ä»˜æ¬¾å°†ç›´æ¥è½¬ç»™å•†æˆ·ï¼Œå¡åŒ…ä¸å‚ä¸æ”¶æ¬¾")],-1)),!d.value.payment_config.has_alipay||!d.value.payment_config.has_wechat?(n(),s("div",ra," æ‰“å¼€"+i(u.value?u.value==="alipay"?"æ”¯ä»˜å®":"å¾®ä¿¡":"æ”¯ä»˜å®/å¾®ä¿¡")+"æ‰«ä¸€æ‰« â†’ æ‰«ææ”¯ä»˜ç ;è¾“å…¥ä»˜æ¬¾é‡‘é¢Â¥"+i((m.value.price/100).toFixed(2))+"å…ƒ ",1)):(n(),s("button",{key:2,class:"purchase-btn",onClick:V,disabled:!u.value||q.value},i(q.value?"å¤„ç†ä¸­...":"ç«‹å³è´­ä¹°"),9,ca))])):(n(),s("div",na,[e[16]||(e[16]=a("p",null,"è¯·å…ˆç™»å½•åå†è´­ä¹°",-1)),a("button",{class:"login-btn",onClick:pe},"å»ç™»å½•")]))])])])):p("",!0),F.value?(n(),s("div",{key:1,class:"modal-overlay",onClick:R(J,["self"])},[a("div",da,[a("div",{class:"modal-header"},[e[21]||(e[21]=a("h3",null,"ç»‘å®šæ‰‹æœºå·",-1)),a("button",{class:"close-btn",onClick:J},"Ã—")]),a("div",va,[a("div",pa,[e[22]||(e[22]=a("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"æ‰‹æœºå·",-1)),te(a("input",{"onUpdate:modelValue":e[4]||(e[4]=l=>y.value.phone=l),type:"tel",placeholder:"è¯·è¾“å…¥æ‰‹æœºå·",class:"w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary"},null,512),[[le,y.value.phone]])]),a("div",ma,[e[23]||(e[23]=a("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"éªŒè¯ç ",-1)),a("div",ya,[te(a("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>y.value.code=l),type:"text",placeholder:"è¯·è¾“å…¥éªŒè¯ç ",class:"flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary"},null,512),[[le,y.value.code]]),a("button",{type:"button",disabled:S.value||b.value>0,class:"px-3 py-3 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors disabled:opacity-50 whitespace-nowrap shrink-0",onClick:re},i(b.value>0?`${b.value}s`:S.value?"å‘é€ä¸­...":"å‘é€éªŒè¯ç "),9,fa)])]),a("button",{class:"purchase-btn",onClick:ce,disabled:M.value},i(M.value?"å¤„ç†ä¸­...":"ç»‘å®šå¹¶ç»§ç»­"),9,ha)])])])):p("",!0),T.value?(n(),s("div",{key:2,class:"modal-overlay",onClick:R(z,["self"])},[a("div",_a,[a("div",ga,[a("h3",ba,i(oe.value),1),a("button",{class:"close-btn",onClick:z},"Ã—")]),a("div",wa,[a("div",ka,[a("div",{class:w(["payment-amount",{"payment-amount-alipay":u.value==="alipay","payment-amount-wechat":u.value==="wechat"}])},[e[24]||(e[24]=a("span",null,"æ”¯ä»˜é‡‘é¢ï¼š",-1)),a("span",Ca,"Â¥"+i((((o=f.value)==null?void 0:o.price)/100).toFixed(2)),1)],2),g.value?(n(),s("div",{key:0,class:w(["payment-qrcode",{"payment-qrcode-alipay":u.value==="alipay","payment-qrcode-wechat":u.value==="wechat"}])},[me(g.value)?(n(),s("div",xa,[a("img",{src:g.value,alt:"æ”¶æ¬¾ç ",onClick:e[6]||(e[6]=l=>C(u.value))},null,8,Pa),a("div",{class:"qrcode-text",onClick:e[7]||(e[7]=l=>C(u.value))},"ç‚¹å‡»æ”¯ä»˜ç  ç›´æ¥æ‰«ç æ”¯ä»˜")])):p("",!0)],2)):p("",!0),u.value&&!g.value?(n(),s("button",{key:1,class:"purchase-btn",type:"button",onClick:e[8]||(e[8]=l=>C(u.value))},i(u.value==="alipay"?"æ‰“å¼€æ”¯ä»˜å®æ‰«ä¸€æ‰«":"æ‰“å¼€å¾®ä¿¡æ‰«ä¸€æ‰«"),1)):p("",!0),a("button",{class:w(["save-payment-btn",{"save-payment-btn-wechat":u.value==="wechat"}]),onClick:ye,disabled:U.value}," ä¿å­˜æ”¯ä»˜ç è‡³æ‰‹æœºä»˜æ¬¾ ",10,Ia),x.value?(n(),s("div",{key:2,class:w(["payment-guide",{"payment-guide-wechat":u.value==="wechat",highlighted:I.value}]),onClick:fe},[e[25]||(e[25]=a("div",{class:"payment-guide-icon"},"ğŸ“±",-1)),a("div",$a," æ‰“å¼€"+i(u.value==="alipay"?"æ”¯ä»˜å®":"å¾®ä¿¡")+"æ‰«ä¸€æ‰« â†’ ç‚¹å‡»ç›¸å†Œ â†’ é€‰æ‹©æ”¯ä»˜ç ;è¾“å…¥ä»˜æ¬¾é‡‘é¢Â¥"+i((((r=f.value)==null?void 0:r.price)/100).toFixed(2))+"å…ƒ ",1)],2)):p("",!0)]),P.value?(n(),s("div",Ta,[a("button",{class:"cancel-btn",onClick:z},"å–æ¶ˆ"),a("button",{class:"confirm-btn",onClick:he,disabled:D.value},i(D.value?"æäº¤ä¸­...":"å·²å®Œæˆä»˜æ¬¾"),9,Ba)])):p("",!0)])])])):p("",!0),G.value?(n(),s("div",Fa,[a("div",{class:"modal success-modal"},[e[26]||(e[26]=a("div",{class:"success-icon"},"âœ“",-1)),e[27]||(e[27]=a("h3",null,"å·²æäº¤ä»˜æ¬¾",-1)),e[28]||(e[28]=a("p",null,"ç­‰å¾…å•†æˆ·ç¡®è®¤åï¼Œå¡ç‰‡å°†è‡ªåŠ¨åŠ å…¥æ‚¨çš„å¡åŒ…",-1)),a("button",{class:"view-btn",onClick:_e},"æŸ¥çœ‹æˆ‘çš„å¡åŒ…")])])):p("",!0)],64)):(n(),s("div",Fe,[...e[10]||(e[10]=[a("div",{class:"error-icon"},"ğŸ˜•",-1),a("h2",null,"åº—é“ºä¸å­˜åœ¨",-1),a("p",null,"è¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®",-1)])]))])}}},Ua=$e(Ma,[["__scopeId","data-v-197a2463"]]);export{Ua as default};
