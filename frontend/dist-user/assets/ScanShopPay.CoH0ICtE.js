import{e as r,s as D,u as M,x as N,f as g,g as a,j as V,n as h,t as x,o as m}from"./vendor.Da2sdW28.js";import{_ as $,H as B}from"./PwaInstallGuide.DykFy_Bj.js";const A={class:"min-h-screen bg-gray-50"},H={class:"px-4 py-4"},L={class:"bg-white rounded-xl p-4 shadow-sm"},Q={class:"flex items-center justify-between mb-3"},W={key:0,class:"mb-3 p-3 bg-red-50 border border-red-100 text-red-600 rounded-lg text-sm"},z={key:1,class:"mb-3 p-3 rounded-lg text-sm bg-blue-50 text-blue-700 border border-blue-100"},E={class:"mt-4 flex gap-2"},K=["disabled"],P=["disabled"],O={__name:"ScanShopPay",setup(F){const y=M(),u=r(!1),c=r(!1),n=r(!1),i=r(""),v=r(""),p=r(0),o=r([]),w=r(!1),k=r(!1);let d=null,_=0;const R=()=>{y.back()},C=async()=>{try{if(o.value=await B.getCameras(),!w.value&&o.value.length>0){const s=o.value.findIndex(e=>{const t=String((e==null?void 0:e.label)||"").toLowerCase();return t.includes("back")||t.includes("rear")||t.includes("environment")||t.includes("后")||t.includes("背")||t.includes("外")});s>=0&&(p.value=s),w.value=!0}}catch{o.value=[]}},U=()=>{d||(d=new B("qr-reader-pay"))},b=async()=>{var s;if(!(u.value||n.value)){i.value="",v.value="",u.value=!0;try{U(),await C();const e=(s=o.value[p.value])==null?void 0:s.id,t={fps:10,qrbox:{width:250,height:250},aspectRatio:1.777778},S=k.value&&e?{deviceId:{exact:e}}:{facingMode:"environment"};await d.start(S,t,async I=>{const l=Date.now();l-_<1200||(_=l,await q(I))},()=>{}),n.value=!0}catch(e){i.value=(e==null?void 0:e.message)||"启动摄像头失败",n.value=!1}finally{u.value=!1}}},f=async()=>{if(!(!d||!n.value))try{await d.stop(),await d.clear()}catch{}finally{n.value=!1}},j=async()=>{n.value&&(!o.value||o.value.length<=1||(k.value=!0,p.value=(p.value+1)%o.value.length,await f(),await b()))},T=s=>{const e=(s||"").trim();if(!e)return null;try{if(e.startsWith("http://")||e.startsWith("https://")){const l=(new URL(e).pathname||"").split("/").filter(Boolean);return l[0]==="shop"&&l[1]?l[1]==="id"&&l[2]?{kind:"id",value:l[2]}:{kind:"slug",value:l[1]}:null}const t=e.split("/").filter(Boolean);return t[0]==="shop"&&t[1]?t[1]==="id"&&t[2]?{kind:"id",value:t[2]}:{kind:"slug",value:t[1]}:null}catch{return null}},q=async s=>{if(c.value)return;const e=T(s);if(!e){i.value="二维码不是商户售卡码";return}c.value=!0;try{v.value="识别成功，进入店铺中...";const t=e.kind==="slug"?`/s/${encodeURIComponent(e.value)}`:`/s/id/${encodeURIComponent(e.value)}`;await f(),y.replace(t)}catch(t){i.value=(t==null?void 0:t.message)||"跳转失败",v.value=""}finally{c.value=!1}};return D(()=>{const s=localStorage.getItem("userToken"),e=localStorage.getItem("userId");if(!s||!e){y.replace("/login");return}C(),b()}),N(()=>{f()}),(s,e)=>(m(),g("div",A,[a("header",{class:"bg-white px-4 py-3 flex items-center justify-between border-b sticky top-0 z-10"},[a("button",{onClick:R,class:"p-1 text-gray-600"},[...e[0]||(e[0]=[a("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),e[1]||(e[1]=a("span",{class:"font-medium text-gray-800"},"扫码进店",-1)),e[2]||(e[2]=a("div",{class:"w-8"},null,-1))]),V($,{pageKey:"user_scan_shop_pay"}),a("div",H,[a("div",L,[a("div",Q,[e[3]||(e[3]=a("h3",{class:"font-medium text-gray-800"},"相机扫码",-1)),n.value?(m(),g("button",{key:0,onClick:f,class:"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm"}," 停止 ")):h("",!0)]),i.value?(m(),g("div",W,x(i.value),1)):h("",!0),v.value?(m(),g("div",z,x(v.value),1)):h("",!0),e[4]||(e[4]=a("div",{class:"rounded-lg overflow-hidden border border-gray-200 bg-black"},[a("div",{id:"qr-reader-pay",class:"w-full"})],-1)),a("div",E,[a("button",{onClick:b,disabled:u.value||c.value,class:"flex-1 py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50"},x(n.value?"扫描中...":u.value?"启动中...":"开始扫码"),9,K),a("button",{onClick:j,disabled:u.value||c.value||!n.value,class:"px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium disabled:opacity-50"}," 切换 ",8,P)]),e[5]||(e[5]=a("p",{class:"text-gray-400 text-xs mt-3"}," 提示：请扫描商户售卡二维码，识别后将进入对应店铺页。 ",-1))])])]))}};export{O as default};
